import * as tslib_1 from "tslib";
import { WorkerEvents, WorkerAnnotations, WorkerUtils, WorkerObservableMessageTypes } from 'angular-web-worker/common';
/**
 * Handles communication to and from a `WorkerClient` and triggers work with the worker class.
 */
export class WorkerController {
    /**
     * Creates a new `WorkerController`
     * @param workerClass the worker class,
     * @param postMessageFn the worker postMessage function passed into constuctor allowing this to be mocked when running within the app (not the worker script)
     * @param onMessageFn the worker onmessage event function passed into constructor allowing this to be mocked when running within the app (not the worker script)
     */
    constructor(workerClass, messageBus) {
        this.workerClass = workerClass;
        this.messageBus = messageBus;
        try {
            this.worker = WorkerUtils.getAnnotation(workerClass, WorkerAnnotations.Factory)({
                isClient: false
            });
            this.subscriptions = {};
            this.registerEvents();
        }
        catch (e) { }
    }
    /**
     * Returns instance of worker class
     */
    get workerInstance() {
        return this.worker;
    }
    /**
     * Creates the event listeners to correctly handle and respond to messages recieved from a `WorkerClient`
     */
    registerEvents() {
        this.messageBus.onmessage = (ev) => {
            switch (ev.data.type) {
                case WorkerEvents.Callable:
                    this.handleCallable(ev.data);
                    break;
                case WorkerEvents.Accessable:
                    this.handleAccessable(ev.data);
                    break;
                case WorkerEvents.Observable:
                    this.handleSubscription(ev.data);
                    break;
                case WorkerEvents.Init:
                    this.handleInit(ev.data);
                    break;
            }
        };
    }
    /**
     * A utility function to create a new `WorkerResponseEvent` from the details provided by the `WorkerRequestEvent`, as well as the result to be returned
     * @param type The type of worker event
     * @param request The request that the response relates to
     * @param result data to return with the response
     */
    response(type, request, result) {
        return {
            type: type,
            isError: false,
            requestSecret: request.requestSecret,
            propertyName: request.propertyName,
            result: result
        };
    }
    /**
     * A utility function to create a new error in the form of a `WorkerResponseEvent` from the details provided by the `WorkerRequestEvent`, as well as the error to be returned
     * @param type The type of worker event
     * @param request The request that the error relates to
     * @param result the error to be returned
     */
    error(type, request, error) {
        return {
            type: type,
            isError: true,
            requestSecret: request.requestSecret,
            propertyName: request.propertyName,
            error: JSON.stringify(error, this.replaceErrors),
            result: null
        };
    }
    /**
     * A utility function as the replacer for the `JSON.stringify()` function to make the native browser `Error` class serializable to JSON
     */
    replaceErrors(key, value) {
        if (value instanceof Error) {
            const error = {};
            // tslint:disable-next-line: no-shadowed-variable
            Object.getOwnPropertyNames(value).forEach(function (key) {
                error[key] = value[key];
            });
            return error;
        }
        return value;
    }
    /**
     * Handles `WorkerEvents.Init` requests from a client by calling the `onWorkerInit` hook if implemented and only responding once the hook has been completed, regardless of whether it is
     * async or not
     * @param request request recieved from the `WorkerClient`
     */
    handleInit(request) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (this.worker['onWorkerInit']) {
                try {
                    const result = this.worker['onWorkerInit']();
                    let isPromise = false;
                    if (result) {
                        isPromise = result.__proto__.constructor === Promise;
                    }
                    if (isPromise) {
                        result.then(() => {
                            this.postMessage(this.response(WorkerEvents.Init, request, null));
                        }).catch((err) => {
                            this.postMessage(this.error(WorkerEvents.Init, request, err));
                        });
                    }
                    else {
                        this.postMessage(this.response(WorkerEvents.Init, request, null));
                    }
                }
                catch (e) {
                    this.postMessage(this.error(WorkerEvents.Init, request, null));
                }
            }
            else {
                this.postMessage(this.response(WorkerEvents.Init, request, null));
            }
        });
    }
    /**
     * Handles `WorkerEvents.Callable` requests from a client by calling the targeted method and responding with the method's return value
     * @param request request recieved from the `WorkerClient`
     */
    handleCallable(request) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let response;
            try {
                request.body.arguments = this.applyShallowTransferToCallableArgs(request, request.body.arguments);
                const result = yield this.worker[request.propertyName](...request.body.arguments);
                response = this.response(WorkerEvents.Callable, request, result);
            }
            catch (e) {
                response = this.error(WorkerEvents.Callable, request, e);
            }
            finally {
                this.postMessage(response);
            }
        });
    }
    /**
     * Transfers the prototype of any function arguments decorated with `@ShallowTransfer()` which have been serialized and recieved from a `WorkerEvents.Callable` request.
     *  This occurs before the arguments are used to call the worker function.
     * @param request request recieved from the `WorkerClient`
     * @param args array of function arguments
     */
    applyShallowTransferToCallableArgs(request, args) {
        const metaData = WorkerUtils.getAnnotation(this.workerClass, WorkerAnnotations.ShallowTransferArgs, []);
        if (metaData) {
            const shallowTransferMeta = metaData.filter(x => x.name === request.propertyName);
            for (let i = 0; i < args.length; i++) {
                const meta = shallowTransferMeta.filter(x => x.argIndex === i)[0];
                if (meta) {
                    if (meta.type && args[i]) {
                        args[i].__proto__ = meta.type.prototype;
                    }
                }
            }
        }
        return args;
    }
    /**
     * Handles `WorkerEvents.Accessable` requests from a client by either setting the target property of the worker or responding with the target property's value
     * @param request request recieved from the `WorkerClient`
     */
    handleAccessable(request) {
        let response;
        try {
            const metaData = WorkerUtils.getAnnotation(this.workerClass, 'accessables', []).filter(x => x.name === request.propertyName)[0];
            if (request.body.isGet) {
                response = this.response(WorkerEvents.Accessable, request, this.worker[request.propertyName]);
            }
            else {
                this.worker[request.propertyName] = request.body.value;
                if (metaData.shallowTransfer) {
                    if (metaData.type && this.worker[request.propertyName]) {
                        this.worker[request.propertyName].__proto__ = metaData.type.prototype;
                    }
                }
                response = this.response(WorkerEvents.Accessable, request, null);
            }
        }
        catch (e) {
            response = this.error(WorkerEvents.Accessable, request, e);
        }
        finally {
            this.postMessage(response);
        }
    }
    /**
     * Handles `WorkerEvents.Subscribable` requests from a client by creating a new subscription to the targeted observable which will send messages to the client each time
     * an event is triggered by the observable. The function may also unsubscribe from a subscription depending on the details of the request
     * @param request request recieved from the `WorkerClient`
     */
    handleSubscription(request) {
        let response;
        if (!request.body.isUnsubscribe) {
            try {
                this.createSubscription(request);
                response = this.response(WorkerEvents.Observable, request, request.body.subscriptionKey);
            }
            catch (e) {
                this.removeSubscription(request.body.subscriptionKey);
                response = this.error(WorkerEvents.Observable, request, e);
            }
            finally {
                this.postMessage(response);
            }
        }
        else {
            try {
                this.removeSubscription(request.body.subscriptionKey);
                response = this.response(WorkerEvents.Observable, request, null);
            }
            catch (e) {
                response = this.error(WorkerEvents.Observable, request, e);
            }
            finally {
                this.postMessage(response);
            }
        }
    }
    /**
     * Creates a new subscription to a worker observable and adds it to the `subscriptions` dictionary. The subscriptions will send messages to the client each time
     *  and event is triggered by the observable
     * @param request request recieved from the `WorkerClient`
     */
    createSubscription(request) {
        this.removeSubscription(request.body.subscriptionKey);
        this.subscriptions[request.body.subscriptionKey] = this.worker[request.propertyName].subscribe((val) => {
            const response = {
                type: WorkerEvents.ObservableMessage,
                propertyName: request.propertyName,
                isError: false,
                requestSecret: null,
                result: {
                    key: request.body.subscriptionKey,
                    type: WorkerObservableMessageTypes.Next,
                    value: val
                }
            };
            this.postSubscriptionMessage(response);
        }, err => {
            const response = {
                type: WorkerEvents.ObservableMessage,
                propertyName: request.propertyName,
                isError: true,
                requestSecret: null,
                result: {
                    key: request.body.subscriptionKey,
                    type: WorkerObservableMessageTypes.Error,
                    error: JSON.parse(JSON.stringify(err, this.replaceErrors))
                }
            };
            this.postSubscriptionMessage(response);
        }, () => {
            const response = {
                type: WorkerEvents.ObservableMessage,
                propertyName: request.propertyName,
                isError: false,
                requestSecret: null,
                result: {
                    key: request.body.subscriptionKey,
                    type: WorkerObservableMessageTypes.Complete,
                }
            };
            this.postSubscriptionMessage(response);
        });
    }
    /**
     * Removes a subscription from the `subscriptions` dictionary, unsubscribing before it is deleted
     * @param subscriptionKey key in dictionary
     */
    removeSubscription(subscriptionKey) {
        if (this.subscriptions[subscriptionKey]) {
            this.subscriptions[subscriptionKey].unsubscribe();
        }
        delete this.subscriptions[subscriptionKey];
    }
    /**
     * Unsubscribes from all subscriptions
     */
    removeAllSubscriptions() {
        for (const key in this.subscriptions) {
            if (this.subscriptions[key]) {
                this.subscriptions[key].unsubscribe();
                delete this.subscriptions[key];
            }
        }
    }
    /**
     * A wrapper function around the `postMessage()` method allowing serialization errors to be caught and sent to the client as a `WorkerResponseEvent`.
     * Only used when the response is triggered by a request, which is not the case when the event type is `WorkerEvents.ObservableMessage`.
     * @param response reponse to send to the client
     */
    postMessage(response) {
        try {
            this.messageBus.postMessage(response);
        }
        catch (e) {
            const errorResponse = {
                type: response.type,
                isError: true,
                requestSecret: response.requestSecret,
                propertyName: response.propertyName,
                error: JSON.parse(JSON.stringify(new Error('Unable to serialize response from worker to client'), this.replaceErrors)),
                result: null
            };
            this.messageBus.postMessage(errorResponse);
        }
    }
    /**
     * A wrapper function around the `postMessage()` method allowing serialization errors to be caught and sent to the client as a `WorkerResponseEvent`.
     * Only used when the response type is `WorkerEvents.ObservableMessage` which requires a different implementation to the `WorkerController.postMessage` wrapper as it
     * is one-way communication which is not triggered by a request
     */
    postSubscriptionMessage(response) {
        try {
            this.messageBus.postMessage(response);
        }
        catch (e) {
            const errorResponse = {
                type: response.type,
                isError: true,
                requestSecret: response.requestSecret,
                propertyName: response.propertyName,
                result: {
                    key: response.result.key,
                    type: WorkerObservableMessageTypes.Error,
                    error: JSON.parse(JSON.stringify(new Error('Unable to serialize subscribable response from worker to client'), this.replaceErrors))
                },
            };
            this.messageBus.postMessage(errorResponse);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXdlYi13b3JrZXIvIiwic291cmNlcyI6WyJsaWIvd29ya2VyLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFDNkMsWUFBWSxFQUFFLGlCQUFpQixFQUMvRSxXQUFXLEVBQ2tDLDRCQUE0QixFQUM1RSxNQUFNLDJCQUEyQixDQUFDO0FBRW5DOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGdCQUFnQjtJQVd6Qjs7Ozs7T0FLRztJQUNILFlBQW9CLFdBQStCLEVBQVUsVUFBNEI7UUFBckUsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBa0I7UUFDckYsSUFBSTtZQUNBLElBQUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBVyxXQUFXLEVBQUUsaUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3RGLFFBQVEsRUFBRSxLQUFLO2FBQ2xCLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUN6QjtRQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUc7SUFDbkIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSSxjQUFjO1FBQ2QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7T0FFRztJQUNLLGNBQWM7UUFDbEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxFQUF3QyxFQUFFLEVBQUU7WUFDckUsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDbEIsS0FBSyxZQUFZLENBQUMsUUFBUTtvQkFDdEIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQzdCLE1BQU07Z0JBQ1YsS0FBSyxZQUFZLENBQUMsVUFBVTtvQkFDeEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDL0IsTUFBTTtnQkFDVixLQUFLLFlBQVksQ0FBQyxVQUFVO29CQUN4QixJQUFJLENBQUMsa0JBQWtCLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNqQyxNQUFNO2dCQUNWLEtBQUssWUFBWSxDQUFDLElBQUk7b0JBQ2xCLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUN6QixNQUFNO2FBQ2I7UUFDTCxDQUFDLENBQUM7SUFDTixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSyxRQUFRLENBQ1osSUFBZSxFQUNmLE9BQXNDLEVBQ3RDLE1BQVc7UUFFWCxPQUFPO1lBQ0gsSUFBSSxFQUFFLElBQUk7WUFDVixPQUFPLEVBQUUsS0FBSztZQUNkLGFBQWEsRUFBRSxPQUFPLENBQUMsYUFBYTtZQUNwQyxZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDbEMsTUFBTSxFQUFFLE1BQU07U0FDakIsQ0FBQztJQUNOLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNLLEtBQUssQ0FDVCxJQUFZLEVBQ1osT0FBc0MsRUFDdEMsS0FBVTtRQUVWLE9BQU87WUFDSCxJQUFJLEVBQUUsSUFBSTtZQUNWLE9BQU8sRUFBRSxJQUFJO1lBQ2IsYUFBYSxFQUFFLE9BQU8sQ0FBQyxhQUFhO1lBQ3BDLFlBQVksRUFBRSxPQUFPLENBQUMsWUFBWTtZQUNsQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQztZQUNoRCxNQUFNLEVBQUUsSUFBSTtTQUNmLENBQUM7SUFDTixDQUFDO0lBRUQ7O09BRUc7SUFDSyxhQUFhLENBQUMsR0FBVyxFQUFFLEtBQVU7UUFDekMsSUFBSSxLQUFLLFlBQVksS0FBSyxFQUFFO1lBQ3hCLE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUNqQixpREFBaUQ7WUFDakQsTUFBTSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEdBQUc7Z0JBQ25ELEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUIsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0csVUFBVSxDQUFDLE9BQThDOztZQUMzRCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLEVBQUU7Z0JBQzdCLElBQUk7b0JBQ0EsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDO29CQUM3QyxJQUFJLFNBQVMsR0FBRyxLQUFLLENBQUM7b0JBQ3RCLElBQUksTUFBTSxFQUFFO3dCQUNSLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLFdBQVcsS0FBSyxPQUFPLENBQUM7cUJBQ3hEO29CQUNELElBQUksU0FBUyxFQUFFO3dCQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFOzRCQUNiLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO3dCQUN0RSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRTs0QkFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7d0JBQ2xFLENBQUMsQ0FBQyxDQUFDO3FCQUNOO3lCQUFNO3dCQUNILElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO3FCQUNyRTtpQkFDSjtnQkFBQyxPQUFPLENBQUMsRUFBRTtvQkFDUixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztpQkFDbEU7YUFDSjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQzthQUNyRTtRQUNMLENBQUM7S0FBQTtJQUdEOzs7T0FHRztJQUNHLGNBQWMsQ0FBQyxPQUFrRDs7WUFDbkUsSUFBSSxRQUFrQyxDQUFDO1lBQ3ZDLElBQUk7Z0JBQ0EsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNsRyxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFFbEYsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDcEU7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDUixRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQzthQUM1RDtvQkFBUztnQkFDTixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzlCO1FBRUwsQ0FBQztLQUFBO0lBRUQ7Ozs7O09BS0c7SUFDSCxrQ0FBa0MsQ0FDOUIsT0FBa0QsRUFDbEQsSUFBVztRQUdYLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxhQUFhLENBQWlDLElBQUksQ0FBQyxXQUFXLEVBQUUsaUJBQWlCLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFeEksSUFBSSxRQUFRLEVBQUU7WUFDVixNQUFNLG1CQUFtQixHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNsRixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDbEMsTUFBTSxJQUFJLEdBQUcsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEUsSUFBSSxJQUFJLEVBQUU7b0JBQ04sSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTt3QkFDdEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztxQkFDM0M7aUJBQ0o7YUFDSjtTQUNKO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVEOzs7T0FHRztJQUNILGdCQUFnQixDQUFDLE9BQW9EO1FBQ2pFLElBQUksUUFBa0MsQ0FBQztRQUN2QyxJQUFJO1lBQ0EsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBdUIsSUFBSSxDQUFDLFdBQVcsRUFBRSxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEosSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDcEIsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQzthQUNqRztpQkFBTTtnQkFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztnQkFDdkQsSUFBSSxRQUFRLENBQUMsZUFBZSxFQUFFO29CQUMxQixJQUFJLFFBQVEsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUU7d0JBQ3BELElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztxQkFDekU7aUJBQ0o7Z0JBQ0QsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDcEU7U0FDSjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDOUQ7Z0JBQVM7WUFDTixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzlCO0lBQ0wsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxrQkFBa0IsQ0FBQyxPQUFvRDtRQUNuRSxJQUFJLFFBQXNELENBQUM7UUFFM0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQzdCLElBQUk7Z0JBQ0EsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNqQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2FBQzVGO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQ3RELFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQzlEO29CQUFTO2dCQUNOLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDOUI7U0FDSjthQUFNO1lBQ0gsSUFBSTtnQkFDQSxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDdEQsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDcEU7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDUixRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQzthQUM5RDtvQkFBUztnQkFDTixJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzlCO1NBQ0o7SUFDTCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILGtCQUFrQixDQUFDLE9BQW9EO1FBRW5FLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRXRELElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBa0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFFLENBQUMsU0FBUyxDQUMxRyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ0osTUFBTSxRQUFRLEdBQWlEO2dCQUMzRCxJQUFJLEVBQUUsWUFBWSxDQUFDLGlCQUFpQjtnQkFDcEMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO2dCQUNsQyxPQUFPLEVBQUUsS0FBSztnQkFDZCxhQUFhLEVBQUUsSUFBSTtnQkFDbkIsTUFBTSxFQUFFO29CQUNKLEdBQUcsRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWU7b0JBQ2pDLElBQUksRUFBRSw0QkFBNEIsQ0FBQyxJQUFJO29CQUN2QyxLQUFLLEVBQUUsR0FBRztpQkFDYjthQUNKLENBQUM7WUFDRixJQUFJLENBQUMsdUJBQXVCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFO1lBQ0wsTUFBTSxRQUFRLEdBQWlEO2dCQUMzRCxJQUFJLEVBQUUsWUFBWSxDQUFDLGlCQUFpQjtnQkFDcEMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO2dCQUNsQyxPQUFPLEVBQUUsSUFBSTtnQkFDYixhQUFhLEVBQUUsSUFBSTtnQkFDbkIsTUFBTSxFQUFFO29CQUNKLEdBQUcsRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWU7b0JBQ2pDLElBQUksRUFBRSw0QkFBNEIsQ0FBQyxLQUFLO29CQUN4QyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7aUJBQzdEO2FBQ0osQ0FBQztZQUNGLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMzQyxDQUFDLEVBQUUsR0FBRyxFQUFFO1lBQ0osTUFBTSxRQUFRLEdBQWlEO2dCQUMzRCxJQUFJLEVBQUUsWUFBWSxDQUFDLGlCQUFpQjtnQkFDcEMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO2dCQUNsQyxPQUFPLEVBQUUsS0FBSztnQkFDZCxhQUFhLEVBQUUsSUFBSTtnQkFDbkIsTUFBTSxFQUFFO29CQUNKLEdBQUcsRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWU7b0JBQ2pDLElBQUksRUFBRSw0QkFBNEIsQ0FBQyxRQUFRO2lCQUM5QzthQUNKLENBQUM7WUFDRixJQUFJLENBQUMsdUJBQXVCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsa0JBQWtCLENBQUMsZUFBdUI7UUFDdEMsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDckQ7UUFDRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsc0JBQXNCO1FBQ2xCLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNsQyxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ3pCLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3RDLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNsQztTQUNKO0lBQ0wsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxXQUFXLENBQ1AsUUFBd0M7UUFFeEMsSUFBSTtZQUNBLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3pDO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDUixNQUFNLGFBQWEsR0FBbUM7Z0JBQ2xELElBQUksRUFBRSxRQUFRLENBQUMsSUFBSTtnQkFDbkIsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsYUFBYSxFQUFFLFFBQVEsQ0FBQyxhQUFhO2dCQUNyQyxZQUFZLEVBQUUsUUFBUSxDQUFDLFlBQVk7Z0JBQ25DLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLENBQUMsb0RBQW9ELENBQUMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ3RILE1BQU0sRUFBRSxJQUFJO2FBQ2YsQ0FBQztZQUNGLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQzlDO0lBQ0wsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCx1QkFBdUIsQ0FDbkIsUUFBc0Q7UUFFdEQsSUFBSTtZQUNBLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3pDO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDUixNQUFNLGFBQWEsR0FBaUQ7Z0JBQ2hFLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSTtnQkFDbkIsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsYUFBYSxFQUFFLFFBQVEsQ0FBQyxhQUFhO2dCQUNyQyxZQUFZLEVBQUUsUUFBUSxDQUFDLFlBQVk7Z0JBQ25DLE1BQU0sRUFBRTtvQkFDSixHQUFHLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHO29CQUN4QixJQUFJLEVBQUUsNEJBQTRCLENBQUMsS0FBSztvQkFDeEMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxpRUFBaUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztpQkFDdEk7YUFDSixDQUFDO1lBQ0YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDOUM7SUFDTCxDQUFDO0NBR0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtcclxuICAgIFdlYldvcmtlclR5cGUsIFdvcmtlclJlcXVlc3RFdmVudCwgV29ya2VyRXZlbnQsIFdvcmtlckV2ZW50cywgV29ya2VyQW5ub3RhdGlvbnMsXHJcbiAgICBXb3JrZXJVdGlscywgV29ya2VyUmVzcG9uc2VFdmVudCwgU2hhbGxvd1RyYW5zZmVyUGFyYW1NZXRhRGF0YSxcclxuICAgIEFjY2Vzc2FibGVNZXRhRGF0YSwgV29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2UsIFdvcmtlck9ic2VydmFibGVNZXNzYWdlVHlwZXMsIENhbGxhYmxlTWV0YURhdGEsIFdvcmtlck1lc3NhZ2VCdXNcclxufSBmcm9tICdhbmd1bGFyLXdlYi13b3JrZXIvY29tbW9uJztcclxuXHJcbi8qKlxyXG4gKiBIYW5kbGVzIGNvbW11bmljYXRpb24gdG8gYW5kIGZyb20gYSBgV29ya2VyQ2xpZW50YCBhbmQgdHJpZ2dlcnMgd29yayB3aXRoIHRoZSB3b3JrZXIgY2xhc3MuXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgV29ya2VyQ29udHJvbGxlcjxUPiB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJbnN0YW5jZSBvZiB0aGUgd29ya2VyIGNsYXNzXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgd29ya2VyOiBhbnk7XHJcbiAgICAvKipcclxuICAgICAqIERpY3Rpb25hcnkgb2Ygc3Vic2NyaXB0aW9ucyB0byBSeEpTIHN1YmplY3RzIHdpdGhpbiB0aGUgd29ya2VyXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3Vic2NyaXB0aW9uczogeyBbaWQ6IHN0cmluZ106IFN1YnNjcmlwdGlvbiB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ3JlYXRlcyBhIG5ldyBgV29ya2VyQ29udHJvbGxlcmBcclxuICAgICAqIEBwYXJhbSB3b3JrZXJDbGFzcyB0aGUgd29ya2VyIGNsYXNzLFxyXG4gICAgICogQHBhcmFtIHBvc3RNZXNzYWdlRm4gdGhlIHdvcmtlciBwb3N0TWVzc2FnZSBmdW5jdGlvbiBwYXNzZWQgaW50byBjb25zdHVjdG9yIGFsbG93aW5nIHRoaXMgdG8gYmUgbW9ja2VkIHdoZW4gcnVubmluZyB3aXRoaW4gdGhlIGFwcCAobm90IHRoZSB3b3JrZXIgc2NyaXB0KVxyXG4gICAgICogQHBhcmFtIG9uTWVzc2FnZUZuIHRoZSB3b3JrZXIgb25tZXNzYWdlIGV2ZW50IGZ1bmN0aW9uIHBhc3NlZCBpbnRvIGNvbnN0cnVjdG9yIGFsbG93aW5nIHRoaXMgdG8gYmUgbW9ja2VkIHdoZW4gcnVubmluZyB3aXRoaW4gdGhlIGFwcCAobm90IHRoZSB3b3JrZXIgc2NyaXB0KVxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHdvcmtlckNsYXNzOiBXZWJXb3JrZXJUeXBlPGFueT4sIHByaXZhdGUgbWVzc2FnZUJ1czogV29ya2VyTWVzc2FnZUJ1cykge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMud29ya2VyID0gV29ya2VyVXRpbHMuZ2V0QW5ub3RhdGlvbjxGdW5jdGlvbj4od29ya2VyQ2xhc3MsIFdvcmtlckFubm90YXRpb25zLkZhY3RvcnkpKHtcclxuICAgICAgICAgICAgICAgIGlzQ2xpZW50OiBmYWxzZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zID0ge307XHJcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudHMoKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7IH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJldHVybnMgaW5zdGFuY2Ugb2Ygd29ya2VyIGNsYXNzXHJcbiAgICAgKi9cclxuICAgIGdldCB3b3JrZXJJbnN0YW5jZSgpOiBUIHtcclxuICAgICAgICByZXR1cm4gdGhpcy53b3JrZXI7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDcmVhdGVzIHRoZSBldmVudCBsaXN0ZW5lcnMgdG8gY29ycmVjdGx5IGhhbmRsZSBhbmQgcmVzcG9uZCB0byBtZXNzYWdlcyByZWNpZXZlZCBmcm9tIGEgYFdvcmtlckNsaWVudGBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSByZWdpc3RlckV2ZW50cygpIHtcclxuICAgICAgICB0aGlzLm1lc3NhZ2VCdXMub25tZXNzYWdlID0gKGV2OiBXb3JrZXJFdmVudDxXb3JrZXJSZXF1ZXN0RXZlbnQ8YW55Pj4pID0+IHtcclxuICAgICAgICAgICAgc3dpdGNoIChldi5kYXRhLnR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgV29ya2VyRXZlbnRzLkNhbGxhYmxlOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2FsbGFibGUoZXYuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFdvcmtlckV2ZW50cy5BY2Nlc3NhYmxlOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQWNjZXNzYWJsZShldi5kYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgV29ya2VyRXZlbnRzLk9ic2VydmFibGU6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVTdWJzY3JpcHRpb24oZXYuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFdvcmtlckV2ZW50cy5Jbml0OlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlSW5pdChldi5kYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBIHV0aWxpdHkgZnVuY3Rpb24gdG8gY3JlYXRlIGEgbmV3IGBXb3JrZXJSZXNwb25zZUV2ZW50YCBmcm9tIHRoZSBkZXRhaWxzIHByb3ZpZGVkIGJ5IHRoZSBgV29ya2VyUmVxdWVzdEV2ZW50YCwgYXMgd2VsbCBhcyB0aGUgcmVzdWx0IHRvIGJlIHJldHVybmVkXHJcbiAgICAgKiBAcGFyYW0gdHlwZSBUaGUgdHlwZSBvZiB3b3JrZXIgZXZlbnRcclxuICAgICAqIEBwYXJhbSByZXF1ZXN0IFRoZSByZXF1ZXN0IHRoYXQgdGhlIHJlc3BvbnNlIHJlbGF0ZXMgdG9cclxuICAgICAqIEBwYXJhbSByZXN1bHQgZGF0YSB0byByZXR1cm4gd2l0aCB0aGUgcmVzcG9uc2VcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSByZXNwb25zZTxFdmVudFR5cGUgZXh0ZW5kcyBudW1iZXI+KFxyXG4gICAgICAgIHR5cGU6IEV2ZW50VHlwZSxcclxuICAgICAgICByZXF1ZXN0OiBXb3JrZXJSZXF1ZXN0RXZlbnQ8RXZlbnRUeXBlPixcclxuICAgICAgICByZXN1bHQ6IGFueVxyXG4gICAgKTogV29ya2VyUmVzcG9uc2VFdmVudDxFdmVudFR5cGU+IHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICAgICAgICBpc0Vycm9yOiBmYWxzZSxcclxuICAgICAgICAgICAgcmVxdWVzdFNlY3JldDogcmVxdWVzdC5yZXF1ZXN0U2VjcmV0LFxyXG4gICAgICAgICAgICBwcm9wZXJ0eU5hbWU6IHJlcXVlc3QucHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICByZXN1bHQ6IHJlc3VsdFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBIHV0aWxpdHkgZnVuY3Rpb24gdG8gY3JlYXRlIGEgbmV3IGVycm9yIGluIHRoZSBmb3JtIG9mIGEgYFdvcmtlclJlc3BvbnNlRXZlbnRgIGZyb20gdGhlIGRldGFpbHMgcHJvdmlkZWQgYnkgdGhlIGBXb3JrZXJSZXF1ZXN0RXZlbnRgLCBhcyB3ZWxsIGFzIHRoZSBlcnJvciB0byBiZSByZXR1cm5lZFxyXG4gICAgICogQHBhcmFtIHR5cGUgVGhlIHR5cGUgb2Ygd29ya2VyIGV2ZW50XHJcbiAgICAgKiBAcGFyYW0gcmVxdWVzdCBUaGUgcmVxdWVzdCB0aGF0IHRoZSBlcnJvciByZWxhdGVzIHRvXHJcbiAgICAgKiBAcGFyYW0gcmVzdWx0IHRoZSBlcnJvciB0byBiZSByZXR1cm5lZFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGVycm9yPEV2ZW50VHlwZSBleHRlbmRzIG51bWJlcj4oXHJcbiAgICAgICAgdHlwZTogbnVtYmVyLFxyXG4gICAgICAgIHJlcXVlc3Q6IFdvcmtlclJlcXVlc3RFdmVudDxFdmVudFR5cGU+LFxyXG4gICAgICAgIGVycm9yOiBhbnlcclxuICAgICk6IFdvcmtlclJlc3BvbnNlRXZlbnQ8RXZlbnRUeXBlPiB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgICAgICAgaXNFcnJvcjogdHJ1ZSxcclxuICAgICAgICAgICAgcmVxdWVzdFNlY3JldDogcmVxdWVzdC5yZXF1ZXN0U2VjcmV0LFxyXG4gICAgICAgICAgICBwcm9wZXJ0eU5hbWU6IHJlcXVlc3QucHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICBlcnJvcjogSlNPTi5zdHJpbmdpZnkoZXJyb3IsIHRoaXMucmVwbGFjZUVycm9ycyksXHJcbiAgICAgICAgICAgIHJlc3VsdDogbnVsbFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBIHV0aWxpdHkgZnVuY3Rpb24gYXMgdGhlIHJlcGxhY2VyIGZvciB0aGUgYEpTT04uc3RyaW5naWZ5KClgIGZ1bmN0aW9uIHRvIG1ha2UgdGhlIG5hdGl2ZSBicm93c2VyIGBFcnJvcmAgY2xhc3Mgc2VyaWFsaXphYmxlIHRvIEpTT05cclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSByZXBsYWNlRXJyb3JzKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSB7fTtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1zaGFkb3dlZC12YXJpYWJsZVxyXG4gICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh2YWx1ZSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XHJcbiAgICAgICAgICAgICAgICBlcnJvcltrZXldID0gdmFsdWVba2V5XTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBlcnJvcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlcyBgV29ya2VyRXZlbnRzLkluaXRgIHJlcXVlc3RzIGZyb20gYSBjbGllbnQgYnkgY2FsbGluZyB0aGUgYG9uV29ya2VySW5pdGAgaG9vayBpZiBpbXBsZW1lbnRlZCBhbmQgb25seSByZXNwb25kaW5nIG9uY2UgdGhlIGhvb2sgaGFzIGJlZW4gY29tcGxldGVkLCByZWdhcmRsZXNzIG9mIHdoZXRoZXIgaXQgaXNcclxuICAgICAqIGFzeW5jIG9yIG5vdFxyXG4gICAgICogQHBhcmFtIHJlcXVlc3QgcmVxdWVzdCByZWNpZXZlZCBmcm9tIHRoZSBgV29ya2VyQ2xpZW50YFxyXG4gICAgICovXHJcbiAgICBhc3luYyBoYW5kbGVJbml0KHJlcXVlc3Q6IFdvcmtlclJlcXVlc3RFdmVudDxXb3JrZXJFdmVudHMuSW5pdD4pIHtcclxuICAgICAgICBpZiAodGhpcy53b3JrZXJbJ29uV29ya2VySW5pdCddKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLndvcmtlclsnb25Xb3JrZXJJbml0J10oKTtcclxuICAgICAgICAgICAgICAgIGxldCBpc1Byb21pc2UgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc1Byb21pc2UgPSByZXN1bHQuX19wcm90b19fLmNvbnN0cnVjdG9yID09PSBQcm9taXNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGlzUHJvbWlzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3N0TWVzc2FnZSh0aGlzLnJlc3BvbnNlKFdvcmtlckV2ZW50cy5Jbml0LCByZXF1ZXN0LCBudWxsKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGhpcy5lcnJvcihXb3JrZXJFdmVudHMuSW5pdCwgcmVxdWVzdCwgZXJyKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGhpcy5yZXNwb25zZShXb3JrZXJFdmVudHMuSW5pdCwgcmVxdWVzdCwgbnVsbCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHRoaXMuZXJyb3IoV29ya2VyRXZlbnRzLkluaXQsIHJlcXVlc3QsIG51bGwpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGhpcy5yZXNwb25zZShXb3JrZXJFdmVudHMuSW5pdCwgcmVxdWVzdCwgbnVsbCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBIYW5kbGVzIGBXb3JrZXJFdmVudHMuQ2FsbGFibGVgIHJlcXVlc3RzIGZyb20gYSBjbGllbnQgYnkgY2FsbGluZyB0aGUgdGFyZ2V0ZWQgbWV0aG9kIGFuZCByZXNwb25kaW5nIHdpdGggdGhlIG1ldGhvZCdzIHJldHVybiB2YWx1ZVxyXG4gICAgICogQHBhcmFtIHJlcXVlc3QgcmVxdWVzdCByZWNpZXZlZCBmcm9tIHRoZSBgV29ya2VyQ2xpZW50YFxyXG4gICAgICovXHJcbiAgICBhc3luYyBoYW5kbGVDYWxsYWJsZShyZXF1ZXN0OiBXb3JrZXJSZXF1ZXN0RXZlbnQ8V29ya2VyRXZlbnRzLkNhbGxhYmxlPikge1xyXG4gICAgICAgIGxldCByZXNwb25zZTogV29ya2VyUmVzcG9uc2VFdmVudDxhbnk+O1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJlcXVlc3QuYm9keS5hcmd1bWVudHMgPSB0aGlzLmFwcGx5U2hhbGxvd1RyYW5zZmVyVG9DYWxsYWJsZUFyZ3MocmVxdWVzdCwgcmVxdWVzdC5ib2R5LmFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMud29ya2VyW3JlcXVlc3QucHJvcGVydHlOYW1lXSguLi5yZXF1ZXN0LmJvZHkuYXJndW1lbnRzKTtcclxuXHJcbiAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZShXb3JrZXJFdmVudHMuQ2FsbGFibGUsIHJlcXVlc3QsIHJlc3VsdCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICByZXNwb25zZSA9IHRoaXMuZXJyb3IoV29ya2VyRXZlbnRzLkNhbGxhYmxlLCByZXF1ZXN0LCBlKTtcclxuICAgICAgICB9IGZpbmFsbHkge1xyXG4gICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHJlc3BvbnNlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVHJhbnNmZXJzIHRoZSBwcm90b3R5cGUgb2YgYW55IGZ1bmN0aW9uIGFyZ3VtZW50cyBkZWNvcmF0ZWQgd2l0aCBgQFNoYWxsb3dUcmFuc2ZlcigpYCB3aGljaCBoYXZlIGJlZW4gc2VyaWFsaXplZCBhbmQgcmVjaWV2ZWQgZnJvbSBhIGBXb3JrZXJFdmVudHMuQ2FsbGFibGVgIHJlcXVlc3QuXHJcbiAgICAgKiAgVGhpcyBvY2N1cnMgYmVmb3JlIHRoZSBhcmd1bWVudHMgYXJlIHVzZWQgdG8gY2FsbCB0aGUgd29ya2VyIGZ1bmN0aW9uLlxyXG4gICAgICogQHBhcmFtIHJlcXVlc3QgcmVxdWVzdCByZWNpZXZlZCBmcm9tIHRoZSBgV29ya2VyQ2xpZW50YFxyXG4gICAgICogQHBhcmFtIGFyZ3MgYXJyYXkgb2YgZnVuY3Rpb24gYXJndW1lbnRzXHJcbiAgICAgKi9cclxuICAgIGFwcGx5U2hhbGxvd1RyYW5zZmVyVG9DYWxsYWJsZUFyZ3MoXHJcbiAgICAgICAgcmVxdWVzdDogV29ya2VyUmVxdWVzdEV2ZW50PFdvcmtlckV2ZW50cy5DYWxsYWJsZT4sXHJcbiAgICAgICAgYXJnczogYW55W11cclxuICAgICk6IGFueVtdIHtcclxuXHJcbiAgICAgICAgY29uc3QgbWV0YURhdGEgPSBXb3JrZXJVdGlscy5nZXRBbm5vdGF0aW9uPFNoYWxsb3dUcmFuc2ZlclBhcmFtTWV0YURhdGFbXT4odGhpcy53b3JrZXJDbGFzcywgV29ya2VyQW5ub3RhdGlvbnMuU2hhbGxvd1RyYW5zZmVyQXJncywgW10pO1xyXG5cclxuICAgICAgICBpZiAobWV0YURhdGEpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2hhbGxvd1RyYW5zZmVyTWV0YSA9IG1ldGFEYXRhLmZpbHRlcih4ID0+IHgubmFtZSA9PT0gcmVxdWVzdC5wcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGEgPSBzaGFsbG93VHJhbnNmZXJNZXRhLmZpbHRlcih4ID0+IHguYXJnSW5kZXggPT09IGkpWzBdO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1ldGEpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobWV0YS50eXBlICYmIGFyZ3NbaV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tpXS5fX3Byb3RvX18gPSBtZXRhLnR5cGUucHJvdG90eXBlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGFyZ3M7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBIYW5kbGVzIGBXb3JrZXJFdmVudHMuQWNjZXNzYWJsZWAgcmVxdWVzdHMgZnJvbSBhIGNsaWVudCBieSBlaXRoZXIgc2V0dGluZyB0aGUgdGFyZ2V0IHByb3BlcnR5IG9mIHRoZSB3b3JrZXIgb3IgcmVzcG9uZGluZyB3aXRoIHRoZSB0YXJnZXQgcHJvcGVydHkncyB2YWx1ZVxyXG4gICAgICogQHBhcmFtIHJlcXVlc3QgcmVxdWVzdCByZWNpZXZlZCBmcm9tIHRoZSBgV29ya2VyQ2xpZW50YFxyXG4gICAgICovXHJcbiAgICBoYW5kbGVBY2Nlc3NhYmxlKHJlcXVlc3Q6IFdvcmtlclJlcXVlc3RFdmVudDxXb3JrZXJFdmVudHMuQWNjZXNzYWJsZT4pIHtcclxuICAgICAgICBsZXQgcmVzcG9uc2U6IFdvcmtlclJlc3BvbnNlRXZlbnQ8YW55PjtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBtZXRhRGF0YSA9IFdvcmtlclV0aWxzLmdldEFubm90YXRpb248QWNjZXNzYWJsZU1ldGFEYXRhW10+KHRoaXMud29ya2VyQ2xhc3MsICdhY2Nlc3NhYmxlcycsIFtdKS5maWx0ZXIoeCA9PiB4Lm5hbWUgPT09IHJlcXVlc3QucHJvcGVydHlOYW1lKVswXTtcclxuICAgICAgICAgICAgaWYgKHJlcXVlc3QuYm9keS5pc0dldCkge1xyXG4gICAgICAgICAgICAgICAgcmVzcG9uc2UgPSB0aGlzLnJlc3BvbnNlKFdvcmtlckV2ZW50cy5BY2Nlc3NhYmxlLCByZXF1ZXN0LCB0aGlzLndvcmtlcltyZXF1ZXN0LnByb3BlcnR5TmFtZV0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy53b3JrZXJbcmVxdWVzdC5wcm9wZXJ0eU5hbWVdID0gcmVxdWVzdC5ib2R5LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1ldGFEYXRhLnNoYWxsb3dUcmFuc2Zlcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtZXRhRGF0YS50eXBlICYmIHRoaXMud29ya2VyW3JlcXVlc3QucHJvcGVydHlOYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndvcmtlcltyZXF1ZXN0LnByb3BlcnR5TmFtZV0uX19wcm90b19fID0gbWV0YURhdGEudHlwZS5wcm90b3R5cGU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzcG9uc2UgPSB0aGlzLnJlc3BvbnNlKFdvcmtlckV2ZW50cy5BY2Nlc3NhYmxlLCByZXF1ZXN0LCBudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmVzcG9uc2UgPSB0aGlzLmVycm9yKFdvcmtlckV2ZW50cy5BY2Nlc3NhYmxlLCByZXF1ZXN0LCBlKTtcclxuICAgICAgICB9IGZpbmFsbHkge1xyXG4gICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHJlc3BvbnNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBIYW5kbGVzIGBXb3JrZXJFdmVudHMuU3Vic2NyaWJhYmxlYCByZXF1ZXN0cyBmcm9tIGEgY2xpZW50IGJ5IGNyZWF0aW5nIGEgbmV3IHN1YnNjcmlwdGlvbiB0byB0aGUgdGFyZ2V0ZWQgb2JzZXJ2YWJsZSB3aGljaCB3aWxsIHNlbmQgbWVzc2FnZXMgdG8gdGhlIGNsaWVudCBlYWNoIHRpbWVcclxuICAgICAqIGFuIGV2ZW50IGlzIHRyaWdnZXJlZCBieSB0aGUgb2JzZXJ2YWJsZS4gVGhlIGZ1bmN0aW9uIG1heSBhbHNvIHVuc3Vic2NyaWJlIGZyb20gYSBzdWJzY3JpcHRpb24gZGVwZW5kaW5nIG9uIHRoZSBkZXRhaWxzIG9mIHRoZSByZXF1ZXN0XHJcbiAgICAgKiBAcGFyYW0gcmVxdWVzdCByZXF1ZXN0IHJlY2lldmVkIGZyb20gdGhlIGBXb3JrZXJDbGllbnRgXHJcbiAgICAgKi9cclxuICAgIGhhbmRsZVN1YnNjcmlwdGlvbihyZXF1ZXN0OiBXb3JrZXJSZXF1ZXN0RXZlbnQ8V29ya2VyRXZlbnRzLk9ic2VydmFibGU+KSB7XHJcbiAgICAgICAgbGV0IHJlc3BvbnNlOiBXb3JrZXJSZXNwb25zZUV2ZW50PFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlPjtcclxuXHJcbiAgICAgICAgaWYgKCFyZXF1ZXN0LmJvZHkuaXNVbnN1YnNjcmliZSkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVTdWJzY3JpcHRpb24ocmVxdWVzdCk7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHRoaXMucmVzcG9uc2UoV29ya2VyRXZlbnRzLk9ic2VydmFibGUsIHJlcXVlc3QsIHJlcXVlc3QuYm9keS5zdWJzY3JpcHRpb25LZXkpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVN1YnNjcmlwdGlvbihyZXF1ZXN0LmJvZHkuc3Vic2NyaXB0aW9uS2V5KTtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5lcnJvcihXb3JrZXJFdmVudHMuT2JzZXJ2YWJsZSwgcmVxdWVzdCwgZSk7XHJcbiAgICAgICAgICAgIH0gZmluYWxseSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVN1YnNjcmlwdGlvbihyZXF1ZXN0LmJvZHkuc3Vic2NyaXB0aW9uS2V5KTtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZShXb3JrZXJFdmVudHMuT2JzZXJ2YWJsZSwgcmVxdWVzdCwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5lcnJvcihXb3JrZXJFdmVudHMuT2JzZXJ2YWJsZSwgcmVxdWVzdCwgZSk7XHJcbiAgICAgICAgICAgIH0gZmluYWxseSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENyZWF0ZXMgYSBuZXcgc3Vic2NyaXB0aW9uIHRvIGEgd29ya2VyIG9ic2VydmFibGUgYW5kIGFkZHMgaXQgdG8gdGhlIGBzdWJzY3JpcHRpb25zYCBkaWN0aW9uYXJ5LiBUaGUgc3Vic2NyaXB0aW9ucyB3aWxsIHNlbmQgbWVzc2FnZXMgdG8gdGhlIGNsaWVudCBlYWNoIHRpbWVcclxuICAgICAqICBhbmQgZXZlbnQgaXMgdHJpZ2dlcmVkIGJ5IHRoZSBvYnNlcnZhYmxlXHJcbiAgICAgKiBAcGFyYW0gcmVxdWVzdCByZXF1ZXN0IHJlY2lldmVkIGZyb20gdGhlIGBXb3JrZXJDbGllbnRgXHJcbiAgICAgKi9cclxuICAgIGNyZWF0ZVN1YnNjcmlwdGlvbihyZXF1ZXN0OiBXb3JrZXJSZXF1ZXN0RXZlbnQ8V29ya2VyRXZlbnRzLk9ic2VydmFibGU+KTogdm9pZCB7XHJcblxyXG4gICAgICAgIHRoaXMucmVtb3ZlU3Vic2NyaXB0aW9uKHJlcXVlc3QuYm9keS5zdWJzY3JpcHRpb25LZXkpO1xyXG5cclxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnNbcmVxdWVzdC5ib2R5LnN1YnNjcmlwdGlvbktleV0gPSAoPFN1YmplY3Q8YW55Pj50aGlzLndvcmtlcltyZXF1ZXN0LnByb3BlcnR5TmFtZV0pLnN1YnNjcmliZShcclxuICAgICAgICAgICAgKHZhbCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2U6IFdvcmtlclJlc3BvbnNlRXZlbnQ8V29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2U+ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlTWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWU6IHJlcXVlc3QucHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzRXJyb3I6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3RTZWNyZXQ6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogcmVxdWVzdC5ib2R5LnN1YnNjcmlwdGlvbktleSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogV29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2VUeXBlcy5OZXh0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRoaXMucG9zdFN1YnNjcmlwdGlvbk1lc3NhZ2UocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9LCBlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2U6IFdvcmtlclJlc3BvbnNlRXZlbnQ8V29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2U+ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlTWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWU6IHJlcXVlc3QucHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzRXJyb3I6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdFNlY3JldDogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiByZXF1ZXN0LmJvZHkuc3Vic2NyaXB0aW9uS2V5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBXb3JrZXJPYnNlcnZhYmxlTWVzc2FnZVR5cGVzLkVycm9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShlcnIsIHRoaXMucmVwbGFjZUVycm9ycykpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRoaXMucG9zdFN1YnNjcmlwdGlvbk1lc3NhZ2UocmVzcG9uc2UpO1xyXG4gICAgICAgICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZTogV29ya2VyUmVzcG9uc2VFdmVudDxXb3JrZXJPYnNlcnZhYmxlTWVzc2FnZT4gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogV29ya2VyRXZlbnRzLk9ic2VydmFibGVNZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5TmFtZTogcmVxdWVzdC5wcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgaXNFcnJvcjogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdFNlY3JldDogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiByZXF1ZXN0LmJvZHkuc3Vic2NyaXB0aW9uS2V5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBXb3JrZXJPYnNlcnZhYmxlTWVzc2FnZVR5cGVzLkNvbXBsZXRlLFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvc3RTdWJzY3JpcHRpb25NZXNzYWdlKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZW1vdmVzIGEgc3Vic2NyaXB0aW9uIGZyb20gdGhlIGBzdWJzY3JpcHRpb25zYCBkaWN0aW9uYXJ5LCB1bnN1YnNjcmliaW5nIGJlZm9yZSBpdCBpcyBkZWxldGVkXHJcbiAgICAgKiBAcGFyYW0gc3Vic2NyaXB0aW9uS2V5IGtleSBpbiBkaWN0aW9uYXJ5XHJcbiAgICAgKi9cclxuICAgIHJlbW92ZVN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb25LZXk6IHN0cmluZykge1xyXG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnNbc3Vic2NyaXB0aW9uS2V5XSkge1xyXG4gICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnNbc3Vic2NyaXB0aW9uS2V5XS51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBkZWxldGUgdGhpcy5zdWJzY3JpcHRpb25zW3N1YnNjcmlwdGlvbktleV07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVbnN1YnNjcmliZXMgZnJvbSBhbGwgc3Vic2NyaXB0aW9uc1xyXG4gICAgICovXHJcbiAgICByZW1vdmVBbGxTdWJzY3JpcHRpb25zKCk6IHZvaWQge1xyXG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuc3Vic2NyaXB0aW9ucykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zW2tleV0pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uc1trZXldLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zdWJzY3JpcHRpb25zW2tleV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBIHdyYXBwZXIgZnVuY3Rpb24gYXJvdW5kIHRoZSBgcG9zdE1lc3NhZ2UoKWAgbWV0aG9kIGFsbG93aW5nIHNlcmlhbGl6YXRpb24gZXJyb3JzIHRvIGJlIGNhdWdodCBhbmQgc2VudCB0byB0aGUgY2xpZW50IGFzIGEgYFdvcmtlclJlc3BvbnNlRXZlbnRgLlxyXG4gICAgICogT25seSB1c2VkIHdoZW4gdGhlIHJlc3BvbnNlIGlzIHRyaWdnZXJlZCBieSBhIHJlcXVlc3QsIHdoaWNoIGlzIG5vdCB0aGUgY2FzZSB3aGVuIHRoZSBldmVudCB0eXBlIGlzIGBXb3JrZXJFdmVudHMuT2JzZXJ2YWJsZU1lc3NhZ2VgLlxyXG4gICAgICogQHBhcmFtIHJlc3BvbnNlIHJlcG9uc2UgdG8gc2VuZCB0byB0aGUgY2xpZW50XHJcbiAgICAgKi9cclxuICAgIHBvc3RNZXNzYWdlPEV2ZW50VHlwZSBleHRlbmRzIG51bWJlcj4oXHJcbiAgICAgICAgcmVzcG9uc2U6IFdvcmtlclJlc3BvbnNlRXZlbnQ8RXZlbnRUeXBlPixcclxuICAgICk6IHZvaWQge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZUJ1cy5wb3N0TWVzc2FnZShyZXNwb25zZSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBjb25zdCBlcnJvclJlc3BvbnNlOiBXb3JrZXJSZXNwb25zZUV2ZW50PEV2ZW50VHlwZT4gPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiByZXNwb25zZS50eXBlLFxyXG4gICAgICAgICAgICAgICAgaXNFcnJvcjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHJlcXVlc3RTZWNyZXQ6IHJlc3BvbnNlLnJlcXVlc3RTZWNyZXQsXHJcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWU6IHJlc3BvbnNlLnByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgICAgIGVycm9yOiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG5ldyBFcnJvcignVW5hYmxlIHRvIHNlcmlhbGl6ZSByZXNwb25zZSBmcm9tIHdvcmtlciB0byBjbGllbnQnKSwgdGhpcy5yZXBsYWNlRXJyb3JzKSksXHJcbiAgICAgICAgICAgICAgICByZXN1bHQ6IG51bGxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5tZXNzYWdlQnVzLnBvc3RNZXNzYWdlKGVycm9yUmVzcG9uc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEEgd3JhcHBlciBmdW5jdGlvbiBhcm91bmQgdGhlIGBwb3N0TWVzc2FnZSgpYCBtZXRob2QgYWxsb3dpbmcgc2VyaWFsaXphdGlvbiBlcnJvcnMgdG8gYmUgY2F1Z2h0IGFuZCBzZW50IHRvIHRoZSBjbGllbnQgYXMgYSBgV29ya2VyUmVzcG9uc2VFdmVudGAuXHJcbiAgICAgKiBPbmx5IHVzZWQgd2hlbiB0aGUgcmVzcG9uc2UgdHlwZSBpcyBgV29ya2VyRXZlbnRzLk9ic2VydmFibGVNZXNzYWdlYCB3aGljaCByZXF1aXJlcyBhIGRpZmZlcmVudCBpbXBsZW1lbnRhdGlvbiB0byB0aGUgYFdvcmtlckNvbnRyb2xsZXIucG9zdE1lc3NhZ2VgIHdyYXBwZXIgYXMgaXRcclxuICAgICAqIGlzIG9uZS13YXkgY29tbXVuaWNhdGlvbiB3aGljaCBpcyBub3QgdHJpZ2dlcmVkIGJ5IGEgcmVxdWVzdFxyXG4gICAgICovXHJcbiAgICBwb3N0U3Vic2NyaXB0aW9uTWVzc2FnZShcclxuICAgICAgICByZXNwb25zZTogV29ya2VyUmVzcG9uc2VFdmVudDxXb3JrZXJPYnNlcnZhYmxlTWVzc2FnZT4sXHJcbiAgICApOiB2b2lkIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VCdXMucG9zdE1lc3NhZ2UocmVzcG9uc2UpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc3QgZXJyb3JSZXNwb25zZTogV29ya2VyUmVzcG9uc2VFdmVudDxXb3JrZXJPYnNlcnZhYmxlTWVzc2FnZT4gPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiByZXNwb25zZS50eXBlLFxyXG4gICAgICAgICAgICAgICAgaXNFcnJvcjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHJlcXVlc3RTZWNyZXQ6IHJlc3BvbnNlLnJlcXVlc3RTZWNyZXQsXHJcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWU6IHJlc3BvbnNlLnByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgICAgIHJlc3VsdDoge1xyXG4gICAgICAgICAgICAgICAgICAgIGtleTogcmVzcG9uc2UucmVzdWx0LmtleSxcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBXb3JrZXJPYnNlcnZhYmxlTWVzc2FnZVR5cGVzLkVycm9yLFxyXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG5ldyBFcnJvcignVW5hYmxlIHRvIHNlcmlhbGl6ZSBzdWJzY3JpYmFibGUgcmVzcG9uc2UgZnJvbSB3b3JrZXIgdG8gY2xpZW50JyksIHRoaXMucmVwbGFjZUVycm9ycykpXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VCdXMucG9zdE1lc3NhZ2UoZXJyb3JSZXNwb25zZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbn1cclxuIl19