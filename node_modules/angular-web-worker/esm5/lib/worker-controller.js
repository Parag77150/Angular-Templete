import * as tslib_1 from "tslib";
import { WorkerEvents, WorkerAnnotations, WorkerUtils, WorkerObservableMessageTypes } from 'angular-web-worker/common';
/**
 * Handles communication to and from a `WorkerClient` and triggers work with the worker class.
 */
var WorkerController = /** @class */ (function () {
    /**
     * Creates a new `WorkerController`
     * @param workerClass the worker class,
     * @param postMessageFn the worker postMessage function passed into constuctor allowing this to be mocked when running within the app (not the worker script)
     * @param onMessageFn the worker onmessage event function passed into constructor allowing this to be mocked when running within the app (not the worker script)
     */
    function WorkerController(workerClass, messageBus) {
        this.workerClass = workerClass;
        this.messageBus = messageBus;
        try {
            this.worker = WorkerUtils.getAnnotation(workerClass, WorkerAnnotations.Factory)({
                isClient: false
            });
            this.subscriptions = {};
            this.registerEvents();
        }
        catch (e) { }
    }
    Object.defineProperty(WorkerController.prototype, "workerInstance", {
        /**
         * Returns instance of worker class
         */
        get: function () {
            return this.worker;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Creates the event listeners to correctly handle and respond to messages recieved from a `WorkerClient`
     */
    WorkerController.prototype.registerEvents = function () {
        var _this = this;
        this.messageBus.onmessage = function (ev) {
            switch (ev.data.type) {
                case WorkerEvents.Callable:
                    _this.handleCallable(ev.data);
                    break;
                case WorkerEvents.Accessable:
                    _this.handleAccessable(ev.data);
                    break;
                case WorkerEvents.Observable:
                    _this.handleSubscription(ev.data);
                    break;
                case WorkerEvents.Init:
                    _this.handleInit(ev.data);
                    break;
            }
        };
    };
    /**
     * A utility function to create a new `WorkerResponseEvent` from the details provided by the `WorkerRequestEvent`, as well as the result to be returned
     * @param type The type of worker event
     * @param request The request that the response relates to
     * @param result data to return with the response
     */
    WorkerController.prototype.response = function (type, request, result) {
        return {
            type: type,
            isError: false,
            requestSecret: request.requestSecret,
            propertyName: request.propertyName,
            result: result
        };
    };
    /**
     * A utility function to create a new error in the form of a `WorkerResponseEvent` from the details provided by the `WorkerRequestEvent`, as well as the error to be returned
     * @param type The type of worker event
     * @param request The request that the error relates to
     * @param result the error to be returned
     */
    WorkerController.prototype.error = function (type, request, error) {
        return {
            type: type,
            isError: true,
            requestSecret: request.requestSecret,
            propertyName: request.propertyName,
            error: JSON.stringify(error, this.replaceErrors),
            result: null
        };
    };
    /**
     * A utility function as the replacer for the `JSON.stringify()` function to make the native browser `Error` class serializable to JSON
     */
    WorkerController.prototype.replaceErrors = function (key, value) {
        if (value instanceof Error) {
            var error_1 = {};
            // tslint:disable-next-line: no-shadowed-variable
            Object.getOwnPropertyNames(value).forEach(function (key) {
                error_1[key] = value[key];
            });
            return error_1;
        }
        return value;
    };
    /**
     * Handles `WorkerEvents.Init` requests from a client by calling the `onWorkerInit` hook if implemented and only responding once the hook has been completed, regardless of whether it is
     * async or not
     * @param request request recieved from the `WorkerClient`
     */
    WorkerController.prototype.handleInit = function (request) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var result, isPromise;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                if (this.worker['onWorkerInit']) {
                    try {
                        result = this.worker['onWorkerInit']();
                        isPromise = false;
                        if (result) {
                            isPromise = result.__proto__.constructor === Promise;
                        }
                        if (isPromise) {
                            result.then(function () {
                                _this.postMessage(_this.response(WorkerEvents.Init, request, null));
                            }).catch(function (err) {
                                _this.postMessage(_this.error(WorkerEvents.Init, request, err));
                            });
                        }
                        else {
                            this.postMessage(this.response(WorkerEvents.Init, request, null));
                        }
                    }
                    catch (e) {
                        this.postMessage(this.error(WorkerEvents.Init, request, null));
                    }
                }
                else {
                    this.postMessage(this.response(WorkerEvents.Init, request, null));
                }
                return [2 /*return*/];
            });
        });
    };
    /**
     * Handles `WorkerEvents.Callable` requests from a client by calling the targeted method and responding with the method's return value
     * @param request request recieved from the `WorkerClient`
     */
    WorkerController.prototype.handleCallable = function (request) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, response, result, e_1;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _b.trys.push([0, 2, 3, 4]);
                        request.body.arguments = this.applyShallowTransferToCallableArgs(request, request.body.arguments);
                        return [4 /*yield*/, (_a = this.worker)[request.propertyName].apply(_a, tslib_1.__spread(request.body.arguments))];
                    case 1:
                        result = _b.sent();
                        response = this.response(WorkerEvents.Callable, request, result);
                        return [3 /*break*/, 4];
                    case 2:
                        e_1 = _b.sent();
                        response = this.error(WorkerEvents.Callable, request, e_1);
                        return [3 /*break*/, 4];
                    case 3:
                        this.postMessage(response);
                        return [7 /*endfinally*/];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Transfers the prototype of any function arguments decorated with `@ShallowTransfer()` which have been serialized and recieved from a `WorkerEvents.Callable` request.
     *  This occurs before the arguments are used to call the worker function.
     * @param request request recieved from the `WorkerClient`
     * @param args array of function arguments
     */
    WorkerController.prototype.applyShallowTransferToCallableArgs = function (request, args) {
        var metaData = WorkerUtils.getAnnotation(this.workerClass, WorkerAnnotations.ShallowTransferArgs, []);
        if (metaData) {
            var shallowTransferMeta = metaData.filter(function (x) { return x.name === request.propertyName; });
            var _loop_1 = function (i) {
                var meta = shallowTransferMeta.filter(function (x) { return x.argIndex === i; })[0];
                if (meta) {
                    if (meta.type && args[i]) {
                        args[i].__proto__ = meta.type.prototype;
                    }
                }
            };
            for (var i = 0; i < args.length; i++) {
                _loop_1(i);
            }
        }
        return args;
    };
    /**
     * Handles `WorkerEvents.Accessable` requests from a client by either setting the target property of the worker or responding with the target property's value
     * @param request request recieved from the `WorkerClient`
     */
    WorkerController.prototype.handleAccessable = function (request) {
        var response;
        try {
            var metaData = WorkerUtils.getAnnotation(this.workerClass, 'accessables', []).filter(function (x) { return x.name === request.propertyName; })[0];
            if (request.body.isGet) {
                response = this.response(WorkerEvents.Accessable, request, this.worker[request.propertyName]);
            }
            else {
                this.worker[request.propertyName] = request.body.value;
                if (metaData.shallowTransfer) {
                    if (metaData.type && this.worker[request.propertyName]) {
                        this.worker[request.propertyName].__proto__ = metaData.type.prototype;
                    }
                }
                response = this.response(WorkerEvents.Accessable, request, null);
            }
        }
        catch (e) {
            response = this.error(WorkerEvents.Accessable, request, e);
        }
        finally {
            this.postMessage(response);
        }
    };
    /**
     * Handles `WorkerEvents.Subscribable` requests from a client by creating a new subscription to the targeted observable which will send messages to the client each time
     * an event is triggered by the observable. The function may also unsubscribe from a subscription depending on the details of the request
     * @param request request recieved from the `WorkerClient`
     */
    WorkerController.prototype.handleSubscription = function (request) {
        var response;
        if (!request.body.isUnsubscribe) {
            try {
                this.createSubscription(request);
                response = this.response(WorkerEvents.Observable, request, request.body.subscriptionKey);
            }
            catch (e) {
                this.removeSubscription(request.body.subscriptionKey);
                response = this.error(WorkerEvents.Observable, request, e);
            }
            finally {
                this.postMessage(response);
            }
        }
        else {
            try {
                this.removeSubscription(request.body.subscriptionKey);
                response = this.response(WorkerEvents.Observable, request, null);
            }
            catch (e) {
                response = this.error(WorkerEvents.Observable, request, e);
            }
            finally {
                this.postMessage(response);
            }
        }
    };
    /**
     * Creates a new subscription to a worker observable and adds it to the `subscriptions` dictionary. The subscriptions will send messages to the client each time
     *  and event is triggered by the observable
     * @param request request recieved from the `WorkerClient`
     */
    WorkerController.prototype.createSubscription = function (request) {
        var _this = this;
        this.removeSubscription(request.body.subscriptionKey);
        this.subscriptions[request.body.subscriptionKey] = this.worker[request.propertyName].subscribe(function (val) {
            var response = {
                type: WorkerEvents.ObservableMessage,
                propertyName: request.propertyName,
                isError: false,
                requestSecret: null,
                result: {
                    key: request.body.subscriptionKey,
                    type: WorkerObservableMessageTypes.Next,
                    value: val
                }
            };
            _this.postSubscriptionMessage(response);
        }, function (err) {
            var response = {
                type: WorkerEvents.ObservableMessage,
                propertyName: request.propertyName,
                isError: true,
                requestSecret: null,
                result: {
                    key: request.body.subscriptionKey,
                    type: WorkerObservableMessageTypes.Error,
                    error: JSON.parse(JSON.stringify(err, _this.replaceErrors))
                }
            };
            _this.postSubscriptionMessage(response);
        }, function () {
            var response = {
                type: WorkerEvents.ObservableMessage,
                propertyName: request.propertyName,
                isError: false,
                requestSecret: null,
                result: {
                    key: request.body.subscriptionKey,
                    type: WorkerObservableMessageTypes.Complete,
                }
            };
            _this.postSubscriptionMessage(response);
        });
    };
    /**
     * Removes a subscription from the `subscriptions` dictionary, unsubscribing before it is deleted
     * @param subscriptionKey key in dictionary
     */
    WorkerController.prototype.removeSubscription = function (subscriptionKey) {
        if (this.subscriptions[subscriptionKey]) {
            this.subscriptions[subscriptionKey].unsubscribe();
        }
        delete this.subscriptions[subscriptionKey];
    };
    /**
     * Unsubscribes from all subscriptions
     */
    WorkerController.prototype.removeAllSubscriptions = function () {
        for (var key in this.subscriptions) {
            if (this.subscriptions[key]) {
                this.subscriptions[key].unsubscribe();
                delete this.subscriptions[key];
            }
        }
    };
    /**
     * A wrapper function around the `postMessage()` method allowing serialization errors to be caught and sent to the client as a `WorkerResponseEvent`.
     * Only used when the response is triggered by a request, which is not the case when the event type is `WorkerEvents.ObservableMessage`.
     * @param response reponse to send to the client
     */
    WorkerController.prototype.postMessage = function (response) {
        try {
            this.messageBus.postMessage(response);
        }
        catch (e) {
            var errorResponse = {
                type: response.type,
                isError: true,
                requestSecret: response.requestSecret,
                propertyName: response.propertyName,
                error: JSON.parse(JSON.stringify(new Error('Unable to serialize response from worker to client'), this.replaceErrors)),
                result: null
            };
            this.messageBus.postMessage(errorResponse);
        }
    };
    /**
     * A wrapper function around the `postMessage()` method allowing serialization errors to be caught and sent to the client as a `WorkerResponseEvent`.
     * Only used when the response type is `WorkerEvents.ObservableMessage` which requires a different implementation to the `WorkerController.postMessage` wrapper as it
     * is one-way communication which is not triggered by a request
     */
    WorkerController.prototype.postSubscriptionMessage = function (response) {
        try {
            this.messageBus.postMessage(response);
        }
        catch (e) {
            var errorResponse = {
                type: response.type,
                isError: true,
                requestSecret: response.requestSecret,
                propertyName: response.propertyName,
                result: {
                    key: response.result.key,
                    type: WorkerObservableMessageTypes.Error,
                    error: JSON.parse(JSON.stringify(new Error('Unable to serialize subscribable response from worker to client'), this.replaceErrors))
                },
            };
            this.messageBus.postMessage(errorResponse);
        }
    };
    return WorkerController;
}());
export { WorkerController };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXdlYi13b3JrZXIvIiwic291cmNlcyI6WyJsaWIvd29ya2VyLWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFDNkMsWUFBWSxFQUFFLGlCQUFpQixFQUMvRSxXQUFXLEVBQ2tDLDRCQUE0QixFQUM1RSxNQUFNLDJCQUEyQixDQUFDO0FBRW5DOztHQUVHO0FBQ0g7SUFXSTs7Ozs7T0FLRztJQUNILDBCQUFvQixXQUErQixFQUFVLFVBQTRCO1FBQXJFLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUFVLGVBQVUsR0FBVixVQUFVLENBQWtCO1FBQ3JGLElBQUk7WUFDQSxJQUFJLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQyxhQUFhLENBQVcsV0FBVyxFQUFFLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUN0RixRQUFRLEVBQUUsS0FBSzthQUNsQixDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDekI7UUFBQyxPQUFPLENBQUMsRUFBRSxHQUFHO0lBQ25CLENBQUM7SUFLRCxzQkFBSSw0Q0FBYztRQUhsQjs7V0FFRzthQUNIO1lBQ0ksT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3ZCLENBQUM7OztPQUFBO0lBRUQ7O09BRUc7SUFDSyx5Q0FBYyxHQUF0QjtRQUFBLGlCQWlCQztRQWhCRyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsR0FBRyxVQUFDLEVBQXdDO1lBQ2pFLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQ2xCLEtBQUssWUFBWSxDQUFDLFFBQVE7b0JBQ3RCLEtBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUM3QixNQUFNO2dCQUNWLEtBQUssWUFBWSxDQUFD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QyxDQUFDO2dCQUN0SCxNQUFNLEVBQUUsSUFBSTthQUNmLENBQUM7WUFDRixJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUM5QztJQUNMLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsa0RBQXVCLEdBQXZCLFVBQ0ksUUFBc0Q7UUFFdEQsSUFBSTtZQUNBLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3pDO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDUixJQUFNLGFBQWEsR0FBaUQ7Z0JBQ2hFLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSTtnQkFDbkIsT0FBTyxFQUFFLElBQUk7Z0JBQ2IsYUFBYSxFQUFFLFFBQVEsQ0FBQyxhQUFhO2dCQUNyQyxZQUFZLEVBQUUsUUFBUSxDQUFDLFlBQVk7Z0JBQ25DLE1BQU0sRUFBRTtvQkFDSixHQUFHLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHO29CQUN4QixJQUFJLEVBQUUsNEJBQTRCLENBQUMsS0FBSztvQkFDeEMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxpRUFBaUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztpQkFDdEk7YUFDSixDQUFDO1lBQ0YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDOUM7SUFDTCxDQUFDO0lBR0wsdUJBQUM7QUFBRCxDQUFDLEFBbFhELElBa1hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7XHJcbiAgICBXZWJXb3JrZXJUeXBlLCBXb3JrZXJSZXF1ZXN0RXZlbnQsIFdvcmtlckV2ZW50LCBXb3JrZXJFdmVudHMsIFdvcmtlckFubm90YXRpb25zLFxyXG4gICAgV29ya2VyVXRpbHMsIFdvcmtlclJlc3BvbnNlRXZlbnQsIFNoYWxsb3dUcmFuc2ZlclBhcmFtTWV0YURhdGEsXHJcbiAgICBBY2Nlc3NhYmxlTWV0YURhdGEsIFdvcmtlck9ic2VydmFibGVNZXNzYWdlLCBXb3JrZXJPYnNlcnZhYmxlTWVzc2FnZVR5cGVzLCBDYWxsYWJsZU1ldGFEYXRhLCBXb3JrZXJNZXNzYWdlQnVzXHJcbn0gZnJvbSAnYW5ndWxhci13ZWItd29ya2VyL2NvbW1vbic7XHJcblxyXG4vKipcclxuICogSGFuZGxlcyBjb21tdW5pY2F0aW9uIHRvIGFuZCBmcm9tIGEgYFdvcmtlckNsaWVudGAgYW5kIHRyaWdnZXJzIHdvcmsgd2l0aCB0aGUgd29ya2VyIGNsYXNzLlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFdvcmtlckNvbnRyb2xsZXI8VD4ge1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5zdGFuY2Ugb2YgdGhlIHdvcmtlciBjbGFzc1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHdvcmtlcjogYW55O1xyXG4gICAgLyoqXHJcbiAgICAgKiBEaWN0aW9uYXJ5IG9mIHN1YnNjcmlwdGlvbnMgdG8gUnhKUyBzdWJqZWN0cyB3aXRoaW4gdGhlIHdvcmtlclxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN1YnNjcmlwdGlvbnM6IHsgW2lkOiBzdHJpbmddOiBTdWJzY3JpcHRpb24gfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIENyZWF0ZXMgYSBuZXcgYFdvcmtlckNvbnRyb2xsZXJgXHJcbiAgICAgKiBAcGFyYW0gd29ya2VyQ2xhc3MgdGhlIHdvcmtlciBjbGFzcyxcclxuICAgICAqIEBwYXJhbSBwb3N0TWVzc2FnZUZuIHRoZSB3b3JrZXIgcG9zdE1lc3NhZ2UgZnVuY3Rpb24gcGFzc2VkIGludG8gY29uc3R1Y3RvciBhbGxvd2luZyB0aGlzIHRvIGJlIG1vY2tlZCB3aGVuIHJ1bm5pbmcgd2l0aGluIHRoZSBhcHAgKG5vdCB0aGUgd29ya2VyIHNjcmlwdClcclxuICAgICAqIEBwYXJhbSBvbk1lc3NhZ2VGbiB0aGUgd29ya2VyIG9ubWVzc2FnZSBldmVudCBmdW5jdGlvbiBwYXNzZWQgaW50byBjb25zdHJ1Y3RvciBhbGxvd2luZyB0aGlzIHRvIGJlIG1vY2tlZCB3aGVuIHJ1bm5pbmcgd2l0aGluIHRoZSBhcHAgKG5vdCB0aGUgd29ya2VyIHNjcmlwdClcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB3b3JrZXJDbGFzczogV2ViV29ya2VyVHlwZTxhbnk+LCBwcml2YXRlIG1lc3NhZ2VCdXM6IFdvcmtlck1lc3NhZ2VCdXMpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmtlciA9IFdvcmtlclV0aWxzLmdldEFubm90YXRpb248RnVuY3Rpb24+KHdvcmtlckNsYXNzLCBXb3JrZXJBbm5vdGF0aW9ucy5GYWN0b3J5KSh7XHJcbiAgICAgICAgICAgICAgICBpc0NsaWVudDogZmFsc2VcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IHt9O1xyXG4gICAgICAgICAgICB0aGlzLnJlZ2lzdGVyRXZlbnRzKCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkgeyB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXR1cm5zIGluc3RhbmNlIG9mIHdvcmtlciBjbGFzc1xyXG4gICAgICovXHJcbiAgICBnZXQgd29ya2VySW5zdGFuY2UoKTogVCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud29ya2VyO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ3JlYXRlcyB0aGUgZXZlbnQgbGlzdGVuZXJzIHRvIGNvcnJlY3RseSBoYW5kbGUgYW5kIHJlc3BvbmQgdG8gbWVzc2FnZXMgcmVjaWV2ZWQgZnJvbSBhIGBXb3JrZXJDbGllbnRgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJFdmVudHMoKSB7XHJcbiAgICAgICAgdGhpcy5tZXNzYWdlQnVzLm9ubWVzc2FnZSA9IChldjogV29ya2VyRXZlbnQ8V29ya2VyUmVxdWVzdEV2ZW50PGFueT4+KSA9PiB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoZXYuZGF0YS50eXBlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFdvcmtlckV2ZW50cy5DYWxsYWJsZTpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUNhbGxhYmxlKGV2LmRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBXb3JrZXJFdmVudHMuQWNjZXNzYWJsZTpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUFjY2Vzc2FibGUoZXYuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU3Vic2NyaXB0aW9uKGV2LmRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBXb3JrZXJFdmVudHMuSW5pdDpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUluaXQoZXYuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQSB1dGlsaXR5IGZ1bmN0aW9uIHRvIGNyZWF0ZSBhIG5ldyBgV29ya2VyUmVzcG9uc2VFdmVudGAgZnJvbSB0aGUgZGV0YWlscyBwcm92aWRlZCBieSB0aGUgYFdvcmtlclJlcXVlc3RFdmVudGAsIGFzIHdlbGwgYXMgdGhlIHJlc3VsdCB0byBiZSByZXR1cm5lZFxyXG4gICAgICogQHBhcmFtIHR5cGUgVGhlIHR5cGUgb2Ygd29ya2VyIGV2ZW50XHJcbiAgICAgKiBAcGFyYW0gcmVxdWVzdCBUaGUgcmVxdWVzdCB0aGF0IHRoZSByZXNwb25zZSByZWxhdGVzIHRvXHJcbiAgICAgKiBAcGFyYW0gcmVzdWx0IGRhdGEgdG8gcmV0dXJuIHdpdGggdGhlIHJlc3BvbnNlXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcmVzcG9uc2U8RXZlbnRUeXBlIGV4dGVuZHMgbnVtYmVyPihcclxuICAgICAgICB0eXBlOiBFdmVudFR5cGUsXHJcbiAgICAgICAgcmVxdWVzdDogV29ya2VyUmVxdWVzdEV2ZW50PEV2ZW50VHlwZT4sXHJcbiAgICAgICAgcmVzdWx0OiBhbnlcclxuICAgICk6IFdvcmtlclJlc3BvbnNlRXZlbnQ8RXZlbnRUeXBlPiB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgICAgICAgaXNFcnJvcjogZmFsc2UsXHJcbiAgICAgICAgICAgIHJlcXVlc3RTZWNyZXQ6IHJlcXVlc3QucmVxdWVzdFNlY3JldCxcclxuICAgICAgICAgICAgcHJvcGVydHlOYW1lOiByZXF1ZXN0LnByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgcmVzdWx0OiByZXN1bHRcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQSB1dGlsaXR5IGZ1bmN0aW9uIHRvIGNyZWF0ZSBhIG5ldyBlcnJvciBpbiB0aGUgZm9ybSBvZiBhIGBXb3JrZXJSZXNwb25zZUV2ZW50YCBmcm9tIHRoZSBkZXRhaWxzIHByb3ZpZGVkIGJ5IHRoZSBgV29ya2VyUmVxdWVzdEV2ZW50YCwgYXMgd2VsbCBhcyB0aGUgZXJyb3IgdG8gYmUgcmV0dXJuZWRcclxuICAgICAqIEBwYXJhbSB0eXBlIFRoZSB0eXBlIG9mIHdvcmtlciBldmVudFxyXG4gICAgICogQHBhcmFtIHJlcXVlc3QgVGhlIHJlcXVlc3QgdGhhdCB0aGUgZXJyb3IgcmVsYXRlcyB0b1xyXG4gICAgICogQHBhcmFtIHJlc3VsdCB0aGUgZXJyb3IgdG8gYmUgcmV0dXJuZWRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBlcnJvcjxFdmVudFR5cGUgZXh0ZW5kcyBudW1iZXI+KFxyXG4gICAgICAgIHR5cGU6IG51bWJlcixcclxuICAgICAgICByZXF1ZXN0OiBXb3JrZXJSZXF1ZXN0RXZlbnQ8RXZlbnRUeXBlPixcclxuICAgICAgICBlcnJvcjogYW55XHJcbiAgICApOiBXb3JrZXJSZXNwb25zZUV2ZW50PEV2ZW50VHlwZT4ge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHR5cGU6IHR5cGUsXHJcbiAgICAgICAgICAgIGlzRXJyb3I6IHRydWUsXHJcbiAgICAgICAgICAgIHJlcXVlc3RTZWNyZXQ6IHJlcXVlc3QucmVxdWVzdFNlY3JldCxcclxuICAgICAgICAgICAgcHJvcGVydHlOYW1lOiByZXF1ZXN0LnByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgZXJyb3I6IEpTT04uc3RyaW5naWZ5KGVycm9yLCB0aGlzLnJlcGxhY2VFcnJvcnMpLFxyXG4gICAgICAgICAgICByZXN1bHQ6IG51bGxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQSB1dGlsaXR5IGZ1bmN0aW9uIGFzIHRoZSByZXBsYWNlciBmb3IgdGhlIGBKU09OLnN0cmluZ2lmeSgpYCBmdW5jdGlvbiB0byBtYWtlIHRoZSBuYXRpdmUgYnJvd3NlciBgRXJyb3JgIGNsYXNzIHNlcmlhbGl6YWJsZSB0byBKU09OXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcmVwbGFjZUVycm9ycyhrZXk6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVycm9yID0ge307XHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc2hhZG93ZWQtdmFyaWFibGVcclxuICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModmFsdWUpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xyXG4gICAgICAgICAgICAgICAgZXJyb3Jba2V5XSA9IHZhbHVlW2tleV07XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gZXJyb3I7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEhhbmRsZXMgYFdvcmtlckV2ZW50cy5Jbml0YCByZXF1ZXN0cyBmcm9tIGEgY2xpZW50IGJ5IGNhbGxpbmcgdGhlIGBvbldvcmtlckluaXRgIGhvb2sgaWYgaW1wbGVtZW50ZWQgYW5kIG9ubHkgcmVzcG9uZGluZyBvbmNlIHRoZSBob29rIGhhcyBiZWVuIGNvbXBsZXRlZCwgcmVnYXJkbGVzcyBvZiB3aGV0aGVyIGl0IGlzXHJcbiAgICAgKiBhc3luYyBvciBub3RcclxuICAgICAqIEBwYXJhbSByZXF1ZXN0IHJlcXVlc3QgcmVjaWV2ZWQgZnJvbSB0aGUgYFdvcmtlckNsaWVudGBcclxuICAgICAqL1xyXG4gICAgYXN5bmMgaGFuZGxlSW5pdChyZXF1ZXN0OiBXb3JrZXJSZXF1ZXN0RXZlbnQ8V29ya2VyRXZlbnRzLkluaXQ+KSB7XHJcbiAgICAgICAgaWYgKHRoaXMud29ya2VyWydvbldvcmtlckluaXQnXSkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy53b3JrZXJbJ29uV29ya2VySW5pdCddKCk7XHJcbiAgICAgICAgICAgICAgICBsZXQgaXNQcm9taXNlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNQcm9taXNlID0gcmVzdWx0Ll9fcHJvdG9fXy5jb25zdHJ1Y3RvciA9PT0gUHJvbWlzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChpc1Byb21pc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGhpcy5yZXNwb25zZShXb3JrZXJFdmVudHMuSW5pdCwgcmVxdWVzdCwgbnVsbCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHRoaXMuZXJyb3IoV29ya2VyRXZlbnRzLkluaXQsIHJlcXVlc3QsIGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHRoaXMucmVzcG9uc2UoV29ya2VyRXZlbnRzLkluaXQsIHJlcXVlc3QsIG51bGwpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wb3N0TWVzc2FnZSh0aGlzLmVycm9yKFdvcmtlckV2ZW50cy5Jbml0LCByZXF1ZXN0LCBudWxsKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKHRoaXMucmVzcG9uc2UoV29ya2VyRXZlbnRzLkluaXQsIHJlcXVlc3QsIG51bGwpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlcyBgV29ya2VyRXZlbnRzLkNhbGxhYmxlYCByZXF1ZXN0cyBmcm9tIGEgY2xpZW50IGJ5IGNhbGxpbmcgdGhlIHRhcmdldGVkIG1ldGhvZCBhbmQgcmVzcG9uZGluZyB3aXRoIHRoZSBtZXRob2QncyByZXR1cm4gdmFsdWVcclxuICAgICAqIEBwYXJhbSByZXF1ZXN0IHJlcXVlc3QgcmVjaWV2ZWQgZnJvbSB0aGUgYFdvcmtlckNsaWVudGBcclxuICAgICAqL1xyXG4gICAgYXN5bmMgaGFuZGxlQ2FsbGFibGUocmVxdWVzdDogV29ya2VyUmVxdWVzdEV2ZW50PFdvcmtlckV2ZW50cy5DYWxsYWJsZT4pIHtcclxuICAgICAgICBsZXQgcmVzcG9uc2U6IFdvcmtlclJlc3BvbnNlRXZlbnQ8YW55PjtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICByZXF1ZXN0LmJvZHkuYXJndW1lbnRzID0gdGhpcy5hcHBseVNoYWxsb3dUcmFuc2ZlclRvQ2FsbGFibGVBcmdzKHJlcXVlc3QsIHJlcXVlc3QuYm9keS5hcmd1bWVudHMpO1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLndvcmtlcltyZXF1ZXN0LnByb3BlcnR5TmFtZV0oLi4ucmVxdWVzdC5ib2R5LmFyZ3VtZW50cyk7XHJcblxyXG4gICAgICAgICAgICByZXNwb25zZSA9IHRoaXMucmVzcG9uc2UoV29ya2VyRXZlbnRzLkNhbGxhYmxlLCByZXF1ZXN0LCByZXN1bHQpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmVzcG9uc2UgPSB0aGlzLmVycm9yKFdvcmtlckV2ZW50cy5DYWxsYWJsZSwgcmVxdWVzdCwgZSk7XHJcbiAgICAgICAgfSBmaW5hbGx5IHtcclxuICAgICAgICAgICAgdGhpcy5wb3N0TWVzc2FnZShyZXNwb25zZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFRyYW5zZmVycyB0aGUgcHJvdG90eXBlIG9mIGFueSBmdW5jdGlvbiBhcmd1bWVudHMgZGVjb3JhdGVkIHdpdGggYEBTaGFsbG93VHJhbnNmZXIoKWAgd2hpY2ggaGF2ZSBiZWVuIHNlcmlhbGl6ZWQgYW5kIHJlY2lldmVkIGZyb20gYSBgV29ya2VyRXZlbnRzLkNhbGxhYmxlYCByZXF1ZXN0LlxyXG4gICAgICogIFRoaXMgb2NjdXJzIGJlZm9yZSB0aGUgYXJndW1lbnRzIGFyZSB1c2VkIHRvIGNhbGwgdGhlIHdvcmtlciBmdW5jdGlvbi5cclxuICAgICAqIEBwYXJhbSByZXF1ZXN0IHJlcXVlc3QgcmVjaWV2ZWQgZnJvbSB0aGUgYFdvcmtlckNsaWVudGBcclxuICAgICAqIEBwYXJhbSBhcmdzIGFycmF5IG9mIGZ1bmN0aW9uIGFyZ3VtZW50c1xyXG4gICAgICovXHJcbiAgICBhcHBseVNoYWxsb3dUcmFuc2ZlclRvQ2FsbGFibGVBcmdzKFxyXG4gICAgICAgIHJlcXVlc3Q6IFdvcmtlclJlcXVlc3RFdmVudDxXb3JrZXJFdmVudHMuQ2FsbGFibGU+LFxyXG4gICAgICAgIGFyZ3M6IGFueVtdXHJcbiAgICApOiBhbnlbXSB7XHJcblxyXG4gICAgICAgIGNvbnN0IG1ldGFEYXRhID0gV29ya2VyVXRpbHMuZ2V0QW5ub3RhdGlvbjxTaGFsbG93VHJhbnNmZXJQYXJhbU1ldGFEYXRhW10+KHRoaXMud29ya2VyQ2xhc3MsIFdvcmtlckFubm90YXRpb25zLlNoYWxsb3dUcmFuc2ZlckFyZ3MsIFtdKTtcclxuXHJcbiAgICAgICAgaWYgKG1ldGFEYXRhKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNoYWxsb3dUcmFuc2Zlck1ldGEgPSBtZXRhRGF0YS5maWx0ZXIoeCA9PiB4Lm5hbWUgPT09IHJlcXVlc3QucHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtZXRhID0gc2hhbGxvd1RyYW5zZmVyTWV0YS5maWx0ZXIoeCA9PiB4LmFyZ0luZGV4ID09PSBpKVswXTtcclxuICAgICAgICAgICAgICAgIGlmIChtZXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGEudHlwZSAmJiBhcmdzW2ldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0uX19wcm90b19fID0gbWV0YS50eXBlLnByb3RvdHlwZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBhcmdzO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlcyBgV29ya2VyRXZlbnRzLkFjY2Vzc2FibGVgIHJlcXVlc3RzIGZyb20gYSBjbGllbnQgYnkgZWl0aGVyIHNldHRpbmcgdGhlIHRhcmdldCBwcm9wZXJ0eSBvZiB0aGUgd29ya2VyIG9yIHJlc3BvbmRpbmcgd2l0aCB0aGUgdGFyZ2V0IHByb3BlcnR5J3MgdmFsdWVcclxuICAgICAqIEBwYXJhbSByZXF1ZXN0IHJlcXVlc3QgcmVjaWV2ZWQgZnJvbSB0aGUgYFdvcmtlckNsaWVudGBcclxuICAgICAqL1xyXG4gICAgaGFuZGxlQWNjZXNzYWJsZShyZXF1ZXN0OiBXb3JrZXJSZXF1ZXN0RXZlbnQ8V29ya2VyRXZlbnRzLkFjY2Vzc2FibGU+KSB7XHJcbiAgICAgICAgbGV0IHJlc3BvbnNlOiBXb3JrZXJSZXNwb25zZUV2ZW50PGFueT47XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgbWV0YURhdGEgPSBXb3JrZXJVdGlscy5nZXRBbm5vdGF0aW9uPEFjY2Vzc2FibGVNZXRhRGF0YVtdPih0aGlzLndvcmtlckNsYXNzLCAnYWNjZXNzYWJsZXMnLCBbXSkuZmlsdGVyKHggPT4geC5uYW1lID09PSByZXF1ZXN0LnByb3BlcnR5TmFtZSlbMF07XHJcbiAgICAgICAgICAgIGlmIChyZXF1ZXN0LmJvZHkuaXNHZXQpIHtcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZShXb3JrZXJFdmVudHMuQWNjZXNzYWJsZSwgcmVxdWVzdCwgdGhpcy53b3JrZXJbcmVxdWVzdC5wcm9wZXJ0eU5hbWVdKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMud29ya2VyW3JlcXVlc3QucHJvcGVydHlOYW1lXSA9IHJlcXVlc3QuYm9keS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChtZXRhRGF0YS5zaGFsbG93VHJhbnNmZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobWV0YURhdGEudHlwZSAmJiB0aGlzLndvcmtlcltyZXF1ZXN0LnByb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53b3JrZXJbcmVxdWVzdC5wcm9wZXJ0eU5hbWVdLl9fcHJvdG9fXyA9IG1ldGFEYXRhLnR5cGUucHJvdG90eXBlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZShXb3JrZXJFdmVudHMuQWNjZXNzYWJsZSwgcmVxdWVzdCwgbnVsbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5lcnJvcihXb3JrZXJFdmVudHMuQWNjZXNzYWJsZSwgcmVxdWVzdCwgZSk7XHJcbiAgICAgICAgfSBmaW5hbGx5IHtcclxuICAgICAgICAgICAgdGhpcy5wb3N0TWVzc2FnZShyZXNwb25zZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlcyBgV29ya2VyRXZlbnRzLlN1YnNjcmliYWJsZWAgcmVxdWVzdHMgZnJvbSBhIGNsaWVudCBieSBjcmVhdGluZyBhIG5ldyBzdWJzY3JpcHRpb24gdG8gdGhlIHRhcmdldGVkIG9ic2VydmFibGUgd2hpY2ggd2lsbCBzZW5kIG1lc3NhZ2VzIHRvIHRoZSBjbGllbnQgZWFjaCB0aW1lXHJcbiAgICAgKiBhbiBldmVudCBpcyB0cmlnZ2VyZWQgYnkgdGhlIG9ic2VydmFibGUuIFRoZSBmdW5jdGlvbiBtYXkgYWxzbyB1bnN1YnNjcmliZSBmcm9tIGEgc3Vic2NyaXB0aW9uIGRlcGVuZGluZyBvbiB0aGUgZGV0YWlscyBvZiB0aGUgcmVxdWVzdFxyXG4gICAgICogQHBhcmFtIHJlcXVlc3QgcmVxdWVzdCByZWNpZXZlZCBmcm9tIHRoZSBgV29ya2VyQ2xpZW50YFxyXG4gICAgICovXHJcbiAgICBoYW5kbGVTdWJzY3JpcHRpb24ocmVxdWVzdDogV29ya2VyUmVxdWVzdEV2ZW50PFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlPikge1xyXG4gICAgICAgIGxldCByZXNwb25zZTogV29ya2VyUmVzcG9uc2VFdmVudDxXb3JrZXJFdmVudHMuT2JzZXJ2YWJsZT47XHJcblxyXG4gICAgICAgIGlmICghcmVxdWVzdC5ib2R5LmlzVW5zdWJzY3JpYmUpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlU3Vic2NyaXB0aW9uKHJlcXVlc3QpO1xyXG4gICAgICAgICAgICAgICAgcmVzcG9uc2UgPSB0aGlzLnJlc3BvbnNlKFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlLCByZXF1ZXN0LCByZXF1ZXN0LmJvZHkuc3Vic2NyaXB0aW9uS2V5KTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVTdWJzY3JpcHRpb24ocmVxdWVzdC5ib2R5LnN1YnNjcmlwdGlvbktleSk7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHRoaXMuZXJyb3IoV29ya2VyRXZlbnRzLk9ic2VydmFibGUsIHJlcXVlc3QsIGUpO1xyXG4gICAgICAgICAgICB9IGZpbmFsbHkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wb3N0TWVzc2FnZShyZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVTdWJzY3JpcHRpb24ocmVxdWVzdC5ib2R5LnN1YnNjcmlwdGlvbktleSk7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHRoaXMucmVzcG9uc2UoV29ya2VyRXZlbnRzLk9ic2VydmFibGUsIHJlcXVlc3QsIG51bGwpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHRoaXMuZXJyb3IoV29ya2VyRXZlbnRzLk9ic2VydmFibGUsIHJlcXVlc3QsIGUpO1xyXG4gICAgICAgICAgICB9IGZpbmFsbHkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wb3N0TWVzc2FnZShyZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDcmVhdGVzIGEgbmV3IHN1YnNjcmlwdGlvbiB0byBhIHdvcmtlciBvYnNlcnZhYmxlIGFuZCBhZGRzIGl0IHRvIHRoZSBgc3Vic2NyaXB0aW9uc2AgZGljdGlvbmFyeS4gVGhlIHN1YnNjcmlwdGlvbnMgd2lsbCBzZW5kIG1lc3NhZ2VzIHRvIHRoZSBjbGllbnQgZWFjaCB0aW1lXHJcbiAgICAgKiAgYW5kIGV2ZW50IGlzIHRyaWdnZXJlZCBieSB0aGUgb2JzZXJ2YWJsZVxyXG4gICAgICogQHBhcmFtIHJlcXVlc3QgcmVxdWVzdCByZWNpZXZlZCBmcm9tIHRoZSBgV29ya2VyQ2xpZW50YFxyXG4gICAgICovXHJcbiAgICBjcmVhdGVTdWJzY3JpcHRpb24ocmVxdWVzdDogV29ya2VyUmVxdWVzdEV2ZW50PFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlPik6IHZvaWQge1xyXG5cclxuICAgICAgICB0aGlzLnJlbW92ZVN1YnNjcmlwdGlvbihyZXF1ZXN0LmJvZHkuc3Vic2NyaXB0aW9uS2V5KTtcclxuXHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zW3JlcXVlc3QuYm9keS5zdWJzY3JpcHRpb25LZXldID0gKDxTdWJqZWN0PGFueT4+dGhpcy53b3JrZXJbcmVxdWVzdC5wcm9wZXJ0eU5hbWVdKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICh2YWwpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlOiBXb3JrZXJSZXNwb25zZUV2ZW50PFdvcmtlck9ic2VydmFibGVNZXNzYWdlPiA9IHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBXb3JrZXJFdmVudHMuT2JzZXJ2YWJsZU1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiByZXF1ZXN0LnByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBpc0Vycm9yOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0U2VjcmV0OiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IHJlcXVlc3QuYm9keS5zdWJzY3JpcHRpb25LZXksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFdvcmtlck9ic2VydmFibGVNZXNzYWdlVHlwZXMuTmV4dCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvc3RTdWJzY3JpcHRpb25NZXNzYWdlKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfSwgZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlOiBXb3JrZXJSZXNwb25zZUV2ZW50PFdvcmtlck9ic2VydmFibGVNZXNzYWdlPiA9IHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBXb3JrZXJFdmVudHMuT2JzZXJ2YWJsZU1lc3NhZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiByZXF1ZXN0LnByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBpc0Vycm9yOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3RTZWNyZXQ6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogcmVxdWVzdC5ib2R5LnN1YnNjcmlwdGlvbktleSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogV29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2VUeXBlcy5FcnJvcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXJyLCB0aGlzLnJlcGxhY2VFcnJvcnMpKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvc3RTdWJzY3JpcHRpb25NZXNzYWdlKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2U6IFdvcmtlclJlc3BvbnNlRXZlbnQ8V29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2U+ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlTWVzc2FnZSxcclxuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWU6IHJlcXVlc3QucHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzRXJyb3I6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3RTZWNyZXQ6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogcmVxdWVzdC5ib2R5LnN1YnNjcmlwdGlvbktleSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogV29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2VUeXBlcy5Db21wbGV0ZSxcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wb3N0U3Vic2NyaXB0aW9uTWVzc2FnZShyZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVtb3ZlcyBhIHN1YnNjcmlwdGlvbiBmcm9tIHRoZSBgc3Vic2NyaXB0aW9uc2AgZGljdGlvbmFyeSwgdW5zdWJzY3JpYmluZyBiZWZvcmUgaXQgaXMgZGVsZXRlZFxyXG4gICAgICogQHBhcmFtIHN1YnNjcmlwdGlvbktleSBrZXkgaW4gZGljdGlvbmFyeVxyXG4gICAgICovXHJcbiAgICByZW1vdmVTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uS2V5OiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zW3N1YnNjcmlwdGlvbktleV0pIHtcclxuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zW3N1YnNjcmlwdGlvbktleV0udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZGVsZXRlIHRoaXMuc3Vic2NyaXB0aW9uc1tzdWJzY3JpcHRpb25LZXldO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogVW5zdWJzY3JpYmVzIGZyb20gYWxsIHN1YnNjcmlwdGlvbnNcclxuICAgICAqL1xyXG4gICAgcmVtb3ZlQWxsU3Vic2NyaXB0aW9ucygpOiB2b2lkIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnN1YnNjcmlwdGlvbnMpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uc1trZXldKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnNba2V5XS51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuc3Vic2NyaXB0aW9uc1trZXldO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQSB3cmFwcGVyIGZ1bmN0aW9uIGFyb3VuZCB0aGUgYHBvc3RNZXNzYWdlKClgIG1ldGhvZCBhbGxvd2luZyBzZXJpYWxpemF0aW9uIGVycm9ycyB0byBiZSBjYXVnaHQgYW5kIHNlbnQgdG8gdGhlIGNsaWVudCBhcyBhIGBXb3JrZXJSZXNwb25zZUV2ZW50YC5cclxuICAgICAqIE9ubHkgdXNlZCB3aGVuIHRoZSByZXNwb25zZSBpcyB0cmlnZ2VyZWQgYnkgYSByZXF1ZXN0LCB3aGljaCBpcyBub3QgdGhlIGNhc2Ugd2hlbiB0aGUgZXZlbnQgdHlwZSBpcyBgV29ya2VyRXZlbnRzLk9ic2VydmFibGVNZXNzYWdlYC5cclxuICAgICAqIEBwYXJhbSByZXNwb25zZSByZXBvbnNlIHRvIHNlbmQgdG8gdGhlIGNsaWVudFxyXG4gICAgICovXHJcbiAgICBwb3N0TWVzc2FnZTxFdmVudFR5cGUgZXh0ZW5kcyBudW1iZXI+KFxyXG4gICAgICAgIHJlc3BvbnNlOiBXb3JrZXJSZXNwb25zZUV2ZW50PEV2ZW50VHlwZT4sXHJcbiAgICApOiB2b2lkIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VCdXMucG9zdE1lc3NhZ2UocmVzcG9uc2UpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc3QgZXJyb3JSZXNwb25zZTogV29ya2VyUmVzcG9uc2VFdmVudDxFdmVudFR5cGU+ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogcmVzcG9uc2UudHlwZSxcclxuICAgICAgICAgICAgICAgIGlzRXJyb3I6IHRydWUsXHJcbiAgICAgICAgICAgICAgICByZXF1ZXN0U2VjcmV0OiByZXNwb25zZS5yZXF1ZXN0U2VjcmV0LFxyXG4gICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiByZXNwb25zZS5wcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShuZXcgRXJyb3IoJ1VuYWJsZSB0byBzZXJpYWxpemUgcmVzcG9uc2UgZnJvbSB3b3JrZXIgdG8gY2xpZW50JyksIHRoaXMucmVwbGFjZUVycm9ycykpLFxyXG4gICAgICAgICAgICAgICAgcmVzdWx0OiBudWxsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZUJ1cy5wb3N0TWVzc2FnZShlcnJvclJlc3BvbnNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBIHdyYXBwZXIgZnVuY3Rpb24gYXJvdW5kIHRoZSBgcG9zdE1lc3NhZ2UoKWAgbWV0aG9kIGFsbG93aW5nIHNlcmlhbGl6YXRpb24gZXJyb3JzIHRvIGJlIGNhdWdodCBhbmQgc2VudCB0byB0aGUgY2xpZW50IGFzIGEgYFdvcmtlclJlc3BvbnNlRXZlbnRgLlxyXG4gICAgICogT25seSB1c2VkIHdoZW4gdGhlIHJlc3BvbnNlIHR5cGUgaXMgYFdvcmtlckV2ZW50cy5PYnNlcnZhYmxlTWVzc2FnZWAgd2hpY2ggcmVxdWlyZXMgYSBkaWZmZXJlbnQgaW1wbGVtZW50YXRpb24gdG8gdGhlIGBXb3JrZXJDb250cm9sbGVyLnBvc3RNZXNzYWdlYCB3cmFwcGVyIGFzIGl0XHJcbiAgICAgKiBpcyBvbmUtd2F5IGNvbW11bmljYXRpb24gd2hpY2ggaXMgbm90IHRyaWdnZXJlZCBieSBhIHJlcXVlc3RcclxuICAgICAqL1xyXG4gICAgcG9zdFN1YnNjcmlwdGlvbk1lc3NhZ2UoXHJcbiAgICAgICAgcmVzcG9uc2U6IFdvcmtlclJlc3BvbnNlRXZlbnQ8V29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2U+LFxyXG4gICAgKTogdm9pZCB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5tZXNzYWdlQnVzLnBvc3RNZXNzYWdlKHJlc3BvbnNlKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVycm9yUmVzcG9uc2U6IFdvcmtlclJlc3BvbnNlRXZlbnQ8V29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2U+ID0ge1xyXG4gICAgICAgICAgICAgICAgdHlwZTogcmVzcG9uc2UudHlwZSxcclxuICAgICAgICAgICAgICAgIGlzRXJyb3I6IHRydWUsXHJcbiAgICAgICAgICAgICAgICByZXF1ZXN0U2VjcmV0OiByZXNwb25zZS5yZXF1ZXN0U2VjcmV0LFxyXG4gICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiByZXNwb25zZS5wcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAgICAgICByZXN1bHQ6IHtcclxuICAgICAgICAgICAgICAgICAgICBrZXk6IHJlc3BvbnNlLnJlc3VsdC5rZXksXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogV29ya2VyT2JzZXJ2YWJsZU1lc3NhZ2VUeXBlcy5FcnJvcixcclxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShuZXcgRXJyb3IoJ1VuYWJsZSB0byBzZXJpYWxpemUgc3Vic2NyaWJhYmxlIHJlc3BvbnNlIGZyb20gd29ya2VyIHRvIGNsaWVudCcpLCB0aGlzLnJlcGxhY2VFcnJvcnMpKVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5tZXNzYWdlQnVzLnBvc3RNZXNzYWdlKGVycm9yUmVzcG9uc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG59XHJcbiJdfQ==