!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("rxjs"),require("angular-web-worker/common"),require("angular-web-worker"),require("@angular/core")):"function"==typeof define&&define.amd?define("angular-web-worker/angular",["exports","rxjs","angular-web-worker/common","angular-web-worker","@angular/core"],r):r(((e=e||self)["angular-web-worker"]=e["angular-web-worker"]||{},e["angular-web-worker"].angular={}),e.rxjs,e["angular-web-worker"].common,e["angular-web-worker"],e.ng.core)}(this,function(e,r,t,o,n){"use strict";var s=function(){function e(e,r){var t=this;this.isTestClient=r,this.messageBus={onmessage:function(){},postMessage:function(e){t.onmessage(new MessageEvent("ClientWebWorker",{data:t.isTestClient?t.serialize(e):e}))}},this.controller=new o.WorkerController(e,this.messageBus)}return Object.defineProperty(e.prototype,"workerInstance",{get:function(){return this.controller.workerInstance},enumerable:!0,configurable:!0}),e.prototype.onmessage=function(e){},e.prototype.postMessage=function(e){this.messageBus.onmessage(new MessageEvent("ClientWebWorker",{data:this.isTestClient?this.serialize(e):e}))},e.prototype.terminate=function(){this.controller.removeAllSubscriptions(),this.controller=null},e.prototype.serialize=function(e){return JSON.parse(JSON.stringify(e))},e.prototype.onerror=function(e){},e.prototype.addEventListener=function(){},e.prototype.removeEventListener=function(){},e.prototype.dispatchEvent=function(e){return!0},e}(),i=function(){function e(e,r,t){void 0===r&&(r=!1),void 0===t&&(t=!1),this.definition=e,this.runInApp=r,this.isTestClient=t}return e.prototype.connect=function(){var e=this;if(!this._isConnected)return this.secrets=[],this.workerSecret=this.generateSecretKey(),this.worker=t.WorkerUtils.getAnnotation(this.definition.worker,t.WorkerAnnotations.Factory)({isClient:!0,clientSecret:this.workerSecret}),this.runInApp?this.workerRef=new s(this.definition.worker,this.isTestClient):this.workerRef=this.definition.initFn(),this.registerEvents(),this.castPromise(this.sendRequest(t.WorkerEvents.Init,{body:function(){return null},isConnect:!0,resolve:function(){e._isConnected=!0},secretError:"Could not initialise worker"}))},e.prototype.destroy=function(){if(this.isConnected){for(var e in this.observables)this.observables[e]&&this.removeSubscription(e);this.workerRef.terminate(),this.secrets=[],this.observables={},this.worker=null,this._isConnected=!1}},Object.defineProperty(e.prototype,"isConnected",{get:function(){return this._isConnected},enumerable:!0,configurable:!0}),e.prototype.get=function(e){var r=this;return this.sendRequest(t.WorkerEvents.Accessable,{workerProperty:e,additionalConditions:[{if:function(e){return e.body.get},reject:function(e){return new Error('WorkerClient: will not apply the get method to the "'+e.propertyName+'" property because the get accessor has been explicity set to false')}}],secretError:"WorkerClient: only properties decorated with @Accessable() can be used in the get method",body:function(){return{isGet:!0}},resolve:function(e){var o=t.WorkerUtils.getAnnotation(r.definition.worker,t.WorkerAnnotations.Accessables).filter(function(r){return r.name===e.propertyName})[0];return o.shallowTransfer&&o.type&&o.type.prototype&&e.result&&(e.result.__proto__=o.type.prototype),e.result}})},e.prototype.set=function(e,r){return this.castPromise(this.sendRequest(t.WorkerEvents.Accessable,{workerProperty:e,additionalConditions:[{if:function(e){return e.body.set},reject:function(e){return new Error('WorkerClient: will not apply the set method to the "'+e.propertyName+'" property because the set accessor has been explicity set to false')}}],secretError:"WorkerClient: only properties decorated with @Accessable() can be used in the set method",body:function(){return{isGet:!1,value:r}}}))},e.prototype.call=function(e){var r=this;return this.sendRequest(t.WorkerEvents.Callable,{workerProperty:e,secretError:"WorkerClient: only methods decorated with @Callable() can be used in the call method",body:function(e){return{arguments:e.body.args}},resolve:function(e){var o=t.WorkerUtils.getAnnotation(r.definition.worker,t.WorkerAnnotations.Callables,[]).filter(function(r){return r.name===e.propertyName})[0];if(o.shallowTransfer){if(o.returnType===Promise)throw new Error("WorkerClient: shallowTransfer will not be true in the @Callable() decorator when the decorated method returns a promise");o.returnType&&e.result&&(e.result.__proto__=o.returnType.prototype)}return e.result}})},e.prototype.subscribe=function(e,r,o,n){var s=this;return this.castPromise(this.sendRequest(t.WorkerEvents.Observable,{workerProperty:e,secretError:"WorkerClient: only methods decorated with @Callable() can be used in the call method",beforeRequest:function(e){return s.createSubscription(e.propertyName,r,o,n)},body:function(e,r){return{isUnsubscribe:!1,subscriptionKey:r}},resolve:function(e,r,t){return s.observables[t].subscription},beforeReject:function(e,r,t){return s.removeSubscription(t)}}))},e.prototype.observe=function(e){var r=this;return this.castPromise(this.sendRequest(t.WorkerEvents.Observable,{workerProperty:e,secretError:"WorkerClient: only methods decorated with @Callable() can be used in the call method",beforeRequest:function(e){return r.createObservable(e.propertyName)},body:function(e,r){return{isUnsubscribe:!1,subscriptionKey:r}},resolve:function(e,t,o){return r.observables[o].observable},beforeReject:function(e,t,o){return r.removeSubscription(o)}}))},e.prototype.unsubscribe=function(e){var r=this.findObservableKey(e);if(r){var o=this.observables[r].propertyName;return this.removeSubscription(r),this.castPromise(this.sendRequest(t.WorkerEvents.Observable,{workerProperty:o,secretError:"",body:function(e){return{isUnsubscribe:!0,subscriptionKey:r}}}))}return new Promise(function(e){return e()})},e.prototype.sendRequest=function(e,r){var t=this;return new Promise(function(o,n){var s,i;if(t._isConnected||r.isConnect)try{var a=void 0===r.workerProperty,u=a?null:t.isSecret("string"==typeof r.workerProperty?t.worker[r.workerProperty]:r.workerProperty(t.worker),e);if(u||a){if(r.additionalConditions)try{for(var c=function(e){var r="function"==typeof Symbol&&e[Symbol.iterator],t=0;return r?r.call(e):{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}(r.additionalConditions),l=c.next();!l.done;l=c.next()){var b=l.value;if(!b.if(u))return void n(b.reject(u))}}catch(e){s={error:e}}finally{try{l&&!l.done&&(i=c.return)&&i.call(c)}finally{if(s)throw s.error}}var p;r.beforeRequest&&(p=r.beforeRequest(u));var f=t.generateSecretKey(),h=t.responseEvent.subscribe(function(s){try{var i=s.type===e&&s.requestSecret===f;(i=a?i:i&&u.propertyName===s.propertyName)&&(s.isError?(t.removeSecretKey(f),r.beforeReject&&r.beforeReject(s,u,p),h.unsubscribe(),n(JSON.parse(s.error))):(t.removeSecretKey(f),r.resolve?o(r.resolve(s,u,p)):o(),h.unsubscribe()))}catch(e){n(e)}}),y={requestSecret:f,propertyName:a?null:u.propertyName,type:e,body:r.body?r.body(u,p):null};t.postMessage(y)}else n(new Error(r.secretError))}catch(e){n(e)}else n(new Error("WorkerClient: the WorkerClient.connect() method must be called before a worker can be accessed"))})},e.prototype.postMessage=function(e){try{this.workerRef.postMessage(e)}catch(e){throw new Error("Unable to serialize the request from the client to the worker")}},e.prototype.castPromise=function(e){return e},e.prototype.createSubscription=function(e,t,o,n){var s=this.generateSubscriptionKey(e),i=new r.Subject,a=i.subscribe(t,o,n);return this.observables[s]={subject:i,subscription:a,propertyName:e,observable:null},s},e.prototype.createObservable=function(e){var t=this.generateSubscriptionKey(e),o=new r.Subject;return this.observables[t]={subject:o,subscription:null,propertyName:e,observable:o.asObservable()},t},e.prototype.findObservableKey=function(e){for(var t in this.observables)if(e instanceof r.Subscription){if(this.observables[t].subscription===e)return t}else if(this.observables[t].observable===e)return t;return null},e.prototype.removeSubscription=function(e){this.observables[e]&&this.observables[e].subscription&&this.observables[e].subscription.unsubscribe(),delete this.observables[e]},e.prototype.generateKey=function(e,r){return e.toUpperCase()+"_"+Array(r).fill(null).map(function(){return Math.round(16*Math.random()).toString(16)}).join("")},e.prototype.generateSubscriptionKey=function(e){for(var r=this.generateKey(e,6);this.observables[r];)r=this.generateKey(e,6);return r},e.prototype.generateSecretKey=function(e){e=e||"client";for(var r=this.generateKey(e,16);-1!==this.secrets.indexOf(r);)r=this.generateKey(e,16);return this.secrets.push(r),r},e.prototype.removeSecretKey=function(e){-1!==this.secrets.indexOf(e)&&this.secrets.splice(this.secrets.indexOf(e),1)},e.prototype.isSecret=function(e,r){return e&&e.clientSecret&&e.propertyName&&e.type&&e.clientSecret===this.workerSecret&&e.type===r?e:null},e.prototype.registerEvents=function(){var e=this;this.responseEvent=new r.Subject,this.observables={},this.workerRef.onmessage=function(r){switch(r.data.type){case t.WorkerEvents.ObservableMessage:var o=r.data.result;if(e.observables[o.key])switch(o.type){case t.WorkerObservableMessageTypes.Next:e.observables[o.key].subject.next(o.value);break;case t.WorkerObservableMessageTypes.Error:e.observables[o.key].subject.error(o.error);break;case t.WorkerObservableMessageTypes.Complete:e.observables[o.key].subject.complete()}break;default:e.responseEvent.next(r.data)}}},e}(),a=function(){function e(e){this.workerDefinitions=e||[]}return e.prototype.createClient=function(e,r){void 0===r&&(r=!1);var t=this.workerDefinitions.filter(function(r){return r.worker===e})[0];if(t)return new i(t,r);throw new Error("WorkerManager: all web workers must be registered in the forWorkers function of the WorkerModule")},Object.defineProperty(e.prototype,"isBrowserCompatible",{get:function(){return"undefined"!=typeof Worker},enumerable:!0,configurable:!0}),e}(),u=function(){function e(){}var r;return r=e,e.forWorkers=function(e){return e.forEach(function(e){if(!t.WorkerUtils.getAnnotation(e.worker,t.WorkerAnnotations.IsWorker))throw new Error("WorkerModule: one or more of the provided workers has not been decorated with the @AngularWebWorker decorator")}),{ngModule:r,providers:[{provide:a,useValue:new a(e)}]}},e=r=function(e,r,t,o){var n,s=arguments.length,i=s<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,r,t,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(i=(s<3?n(i):s>3?n(r,t,i):n(r,t))||i);return s>3&&i&&Object.defineProperty(r,t,i),i}([n.NgModule()],e)}();e.ClientWebWorker=s,e.WorkerClient=i,e.WorkerManager=a,e.WorkerModule=u,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=angular-web-worker-angular.umd.min.js.map