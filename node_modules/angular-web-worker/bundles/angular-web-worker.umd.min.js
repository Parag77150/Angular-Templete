!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("angular-web-worker/common"),require("reflect-metadata")):"function"==typeof define&&define.amd?define("angular-web-worker",["exports","angular-web-worker/common","reflect-metadata"],r):r((e=e||self)["angular-web-worker"]={},e["angular-web-worker"].common)}(this,function(e,r){"use strict";function t(e,r,t,n){return new(t||(t=Promise))(function(s,o){function a(e){try{c(n.next(e))}catch(e){o(e)}}function i(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new t(function(r){r(e.value)}).then(a,i)}c((n=n.apply(e,r||[])).next())})}function n(e,r){var t,n,s,o,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(o){return function(i){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,n&&(s=2&o[0]?n.return:o[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,o[1])).done)return s;switch(n=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(s=(s=a.trys).length>0&&s[s.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){a.label=o[1];break}if(6===o[0]&&a.label<s[1]){a.label=s[1],s=o;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(o);break}s[2]&&a.ops.pop(),a.trys.pop();continue}o=r.call(e,a)}catch(e){o=[6,e],n=0}finally{t=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,i])}}}function s(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,s,o=t.call(e),a=[];try{for(;(void 0===r||r-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){s={error:e}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(s)throw s.error}}return a}function o(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(s(arguments[r]));return e}var a=function(e,t){Object.defineProperty(e,r.WorkerAnnotations.Config,{get:function(){return t},enumerable:!0,configurable:!0})},i=function(e){var t=r.WorkerUtils.getAnnotation(e.__proto__.constructor,r.WorkerAnnotations.Accessables,[]);t&&t.forEach(function(t){var n=e[t.name];delete e[t.name],Object.defineProperty(e,t.name,{get:function(){var e=this.__worker_config__;return e&&e.isClient?{clientSecret:e.clientSecret,type:r.WorkerEvents.Accessable,propertyName:t.name,body:{get:t.get,set:t.set}}:n},set:function(e){n=e},enumerable:!0,configurable:!0})})},c=function(e){var t=r.WorkerUtils.getAnnotation(e.__proto__.constructor,r.WorkerAnnotations.Observables,[]);t&&t.forEach(function(t){var n=e[t.name];delete e[t.name],Object.defineProperty(e,t.name,{get:function(){var e=this.__worker_config__;return e&&e.isClient?{clientSecret:e.clientSecret,type:r.WorkerEvents.Observable,propertyName:t.name,body:null}:n},set:function(e){n=e},enumerable:!0,configurable:!0})})},l={setWorkerConfig:a,configureAccessables:i,configureSubscribables:c};var u=function(){function e(e,t){this.workerClass=e,this.messageBus=t;try{this.worker=r.WorkerUtils.getAnnotation(e,r.WorkerAnnotations.Factory)({isClient:!1}),this.subscriptions={},this.registerEvents()}catch(e){}}return Object.defineProperty(e.prototype,"workerInstance",{get:function(){return this.worker},enumerable:!0,configurable:!0}),e.prototype.registerEvents=function(){var e=this;this.messageBus.onmessage=function(t){switch(t.data.type){case r.WorkerEvents.Callable:e.handleCallable(t.data);break;case r.WorkerEvents.Accessable:e.handleAccessable(t.data);break;case r.WorkerEvents.Observable:e.handleSubscription(t.data);break;case r.WorkerEvents.Init:e.handleInit(t.data)}}},e.prototype.response=function(e,r,t){return{type:e,isError:!1,requestSecret:r.requestSecret,propertyName:r.propertyName,result:t}},e.prototype.error=function(e,r,t){return{type:e,isError:!0,requestSecret:r.requestSecret,propertyName:r.propertyName,error:JSON.stringify(t,this.replaceErrors),result:null}},e.prototype.replaceErrors=function(e,r){if(r instanceof Error){var t={};return Object.getOwnPropertyNames(r).forEach(function(e){t[e]=r[e]}),t}return r},e.prototype.handleInit=function(e){return t(this,void 0,void 0,function(){var t,s,o=this;return n(this,function(n){if(this.worker.onWorkerInit)try{t=this.worker.onWorkerInit(),s=!1,t&&(s=t.__proto__.constructor===Promise),s?t.then(function(){o.postMessage(o.response(r.WorkerEvents.Init,e,null))}).catch(function(t){o.postMessage(o.error(r.WorkerEvents.Init,e,t))}):this.postMessage(this.response(r.WorkerEvents.Init,e,null))}catch(t){this.postMessage(this.error(r.WorkerEvents.Init,e,null))}else this.postMessage(this.response(r.WorkerEvents.Init,e,null));return[2]})})},e.prototype.handleCallable=function(e){return t(this,void 0,void 0,function(){var t,s,a,i;return n(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,3,4]),e.body.arguments=this.applyShallowTransferToCallableArgs(e,e.body.arguments),[4,(t=this.worker)[e.propertyName].apply(t,o(e.body.arguments))];case 1:return a=n.sent(),s=this.response(r.WorkerEvents.Callable,e,a),[3,4];case 2:return i=n.sent(),s=this.error(r.WorkerEvents.Callable,e,i),[3,4];case 3:return this.postMessage(s),[7];case 4:return[2]}})})},e.prototype.applyShallowTransferToCallableArgs=function(e,t){var n=r.WorkerUtils.getAnnotation(this.workerClass,r.WorkerAnnotations.ShallowTransferArgs,[]);if(n)for(var s=n.filter(function(r){return r.name===e.propertyName}),o=function(e){var r=s.filter(function(r){return r.argIndex===e})[0];r&&r.type&&t[e]&&(t[e].__proto__=r.type.prototype)},a=0;a<t.length;a++)o(a);return t},e.prototype.handleAccessable=function(e){var t;try{var n=r.WorkerUtils.getAnnotation(this.workerClass,"accessables",[]).filter(function(r){return r.name===e.propertyName})[0];e.body.isGet?t=this.response(r.WorkerEvents.Accessable,e,this.worker[e.propertyName]):(this.worker[e.propertyName]=e.body.value,n.shallowTransfer&&n.type&&this.worker[e.propertyName]&&(this.worker[e.propertyName].__proto__=n.type.prototype),t=this.response(r.WorkerEvents.Accessable,e,null))}catch(n){t=this.error(r.WorkerEvents.Accessable,e,n)}finally{this.postMessage(t)}},e.prototype.handleSubscription=function(e){var t;if(e.body.isUnsubscribe)try{this.removeSubscription(e.body.subscriptionKey),t=this.response(r.WorkerEvents.Observable,e,null)}catch(n){t=this.error(r.WorkerEvents.Observable,e,n)}finally{this.postMessage(t)}else try{this.createSubscription(e),t=this.response(r.WorkerEvents.Observable,e,e.body.subscriptionKey)}catch(n){this.removeSubscription(e.body.subscriptionKey),t=this.error(r.WorkerEvents.Observable,e,n)}finally{this.postMessage(t)}},e.prototype.createSubscription=function(e){var t=this;this.removeSubscription(e.body.subscriptionKey),this.subscriptions[e.body.subscriptionKey]=this.worker[e.propertyName].subscribe(function(n){var s={type:r.WorkerEvents.ObservableMessage,propertyName:e.propertyName,isError:!1,requestSecret:null,result:{key:e.body.subscriptionKey,type:r.WorkerObservableMessageTypes.Next,value:n}};t.postSubscriptionMessage(s)},function(n){var s={type:r.WorkerEvents.ObservableMessage,propertyName:e.propertyName,isError:!0,requestSecret:null,result:{key:e.body.subscriptionKey,type:r.WorkerObservableMessageTypes.Error,error:JSON.parse(JSON.stringify(n,t.replaceErrors))}};t.postSubscriptionMessage(s)},function(){var n={type:r.WorkerEvents.ObservableMessage,propertyName:e.propertyName,isError:!1,requestSecret:null,result:{key:e.body.subscriptionKey,type:r.WorkerObservableMessageTypes.Complete}};t.postSubscriptionMessage(n)})},e.prototype.removeSubscription=function(e){this.subscriptions[e]&&this.subscriptions[e].unsubscribe(),delete this.subscriptions[e]},e.prototype.removeAllSubscriptions=function(){for(var e in this.subscriptions)this.subscriptions[e]&&(this.subscriptions[e].unsubscribe(),delete this.subscriptions[e])},e.prototype.postMessage=function(e){try{this.messageBus.postMessage(e)}catch(t){var r={type:e.type,isError:!0,requestSecret:e.requestSecret,propertyName:e.propertyName,error:JSON.parse(JSON.stringify(new Error("Unable to serialize response from worker to client"),this.replaceErrors)),result:null};this.messageBus.postMessage(r)}},e.prototype.postSubscriptionMessage=function(e){try{this.messageBus.postMessage(e)}catch(n){var t={type:e.type,isError:!0,requestSecret:e.requestSecret,propertyName:e.propertyName,result:{key:e.result.key,type:r.WorkerObservableMessageTypes.Error,error:JSON.parse(JSON.stringify(new Error("Unable to serialize subscribable response from worker to client"),this.replaceErrors))}};this.messageBus.postMessage(t)}},e}();e.Accessable=function(e){var t={get:!0,set:!0,shallowTransfer:!1};return e&&(t.get=!1!==e.get,t.set=!1!==e.set,t.shallowTransfer=!!e.shallowTransfer),function(e,n){r.WorkerUtils.pushAnnotation(e.constructor,r.WorkerAnnotations.Accessables,{name:n,type:Reflect.getMetadata("design:type",e,n),get:t.get,set:t.set,shallowTransfer:t.shallowTransfer})}},e.AngularWebWorker=function(){return function(e){r.WorkerUtils.setAnnotation(e,r.WorkerAnnotations.IsWorker,!0),r.WorkerUtils.setAnnotation(e,r.WorkerAnnotations.Factory,function(r){var t=new e;return l.setWorkerConfig(t,r),l.configureAccessables(t),l.configureSubscribables(t),t})}},e.Callable=function(e){return function(t,n,s){var a={shallowTransfer:!1};e&&(a.shallowTransfer=!!e.shallowTransfer),r.WorkerUtils.pushAnnotation(t.constructor,r.WorkerAnnotations.Callables,{name:n,shallowTransfer:a.shallowTransfer,returnType:Reflect.getMetadata("design:returntype",t,n)});var i=s.value;return s.value=function(){var e=this,t=Array.prototype.slice.call(arguments),s=e.__worker_config__;if(s){if(s.isClient){var a={clientSecret:e.__worker_config__.clientSecret,type:r.WorkerEvents.Callable,propertyName:n,body:{args:t}};return a}return i.call.apply(i,o([e],t))}return i.call.apply(i,o([e],t))},s}},e.ShallowTransfer=function(){return function(e,t,n){var s=Reflect.getMetadata("design:paramtypes",e,t);r.WorkerUtils.pushAnnotation(e.constructor,r.WorkerAnnotations.ShallowTransferArgs,{name:t,type:s[n],argIndex:n})}},e.Subscribable=function(){return function(e,t){r.WorkerUtils.pushAnnotation(e.constructor,r.WorkerAnnotations.Observables,{name:t,type:Reflect.getMetadata("design:type",e,t)})}},e.WorkerController=u,e.WorkerFactoryFunctions=l,e.bootstrapWorker=function(e){var r={onmessage:function(e){},postMessage:function(e){postMessage(e)}};new u(e,r),onmessage=function(e){r.onmessage(e)}},e.ɵ0=a,e.ɵ1=i,e.ɵ2=c,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=angular-web-worker.umd.min.js.map